<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Joachim Wiberg ">
<meta name="description" content="This is a mini-HowTo on running Finit in an LXC system container. We will be using a variant (external) of Buildroot, called NetBox to create a squashfs (read-only) image for the root filesystem. Then we will give the container a single writable directory from which it then uses bind mount to emulate a full-blown system.
It is expected you have LXC installed and all the relevant build tools needed to create the image. How to set that up is not covered by this tutorial.
" />
<meta name="keywords" content=", howto, finit, init, opensource" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://troglobit.com/post/2022-02-13-finit-in-linux-containers-lxc/" />


    <title>
        
            Finit in Linux Containers (LXC) :: Joachim Wiberg 
        
    </title>





<link rel="stylesheet" href="https://troglobit.com/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css" integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE=">



    <link rel="apple-touch-icon" sizes="180x180" href="https://troglobit.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://troglobit.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://troglobit.com/favicon-16x16.png">
    <link rel="manifest" href="https://troglobit.com/site.webmanifest">
    <link rel="mask-icon" href="https://troglobit.com/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://troglobit.com/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Finit in Linux Containers (LXC)">
<meta itemprop="description" content="This is a mini-HowTo on running Finit in an LXC system container.  We
will be using a variant (external) of Buildroot, called NetBox to
create a squashfs (read-only) image for the root filesystem.  Then we
will give the container a single writable directory from which it then
uses bind mount to emulate a full-blown system.
It is expected you have LXC installed and all the relevant build tools
needed to create the image.  How to set that up is not covered by this
tutorial."><meta itemprop="datePublished" content="2022-02-13T17:55:44+02:00" />
<meta itemprop="dateModified" content="2022-02-13T17:55:44+02:00" />
<meta itemprop="wordCount" content="473">
<meta itemprop="keywords" content="howto,finit,init,opensource," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Finit in Linux Containers (LXC)"/>
<meta name="twitter:description" content="This is a mini-HowTo on running Finit in an LXC system container.  We
will be using a variant (external) of Buildroot, called NetBox to
create a squashfs (read-only) image for the root filesystem.  Then we
will give the container a single writable directory from which it then
uses bind mount to emulate a full-blown system.
It is expected you have LXC installed and all the relevant build tools
needed to create the image.  How to set that up is not covered by this
tutorial."/>



    <meta property="og:title" content="Finit in Linux Containers (LXC)" />
<meta property="og:description" content="This is a mini-HowTo on running Finit in an LXC system container.  We
will be using a variant (external) of Buildroot, called NetBox to
create a squashfs (read-only) image for the root filesystem.  Then we
will give the container a single writable directory from which it then
uses bind mount to emulate a full-blown system.
It is expected you have LXC installed and all the relevant build tools
needed to create the image.  How to set that up is not covered by this
tutorial." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troglobit.com/post/2022-02-13-finit-in-linux-containers-lxc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-13T17:55:44+02:00" />
<meta property="article:modified_time" content="2022-02-13T17:55:44+02:00" />







    <meta property="article:published_time" content="2022-02-13 17:55:44 &#43;0200 &#43;0200" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://troglobit.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text ">
                $ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://troglobit.com/about/">About</a></li><li><a href="https://troglobit.com/posts/">Blog</a></li><li><a href="https://troglobit.com/howtos/">HowTos</a></li><li><a href="https://troglobit.com/projects/">Projects</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        3 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://troglobit.com/post/2022-02-13-finit-in-linux-containers-lxc/">Finit in Linux Containers (LXC)</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>This is a mini-HowTo on running Finit in an LXC system container.  We
will be using a variant (external) of Buildroot, called <a href="https://github.com/westermo/netbox">NetBox</a> to
create a squashfs (read-only) image for the root filesystem.  Then we
will give the container a single writable directory from which it then
uses bind mount to emulate a full-blown system.</p>
<p>It is expected you have LXC installed and all the relevant build tools
needed to create the image.  How to set that up is not covered by this
tutorial.</p>
<p>First we clone NetBox and build an app image for Zero (x86_64):</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/westermo/netbox
</span></span><span style="display:flex;"><span><span style="color:#fabd2f">cd</span> netbox
</span></span><span style="display:flex;"><span>make netbox_app_zero_defconfig
</span></span><span style="display:flex;"><span>make
</span></span></code></pre></div><p>After a few minutes the build has completed and in the <code>output/images/</code>
directory we have the <code>netbox-app-zero.img</code> which we now can set up an
LXC config file for.  Make sure to create the appropriate directories as
we proceed.  Start by copying the .img file to the LXC images directory,
then create this file:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#928374;font-style:italic"># /var/lib/lxc/foo/config </span>
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>uts<span style="color:#fe8019">.</span>name <span style="color:#fe8019">=</span> foo
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>tty<span style="color:#fe8019">.</span>max <span style="color:#fe8019">=</span> <span style="color:#d3869b">4</span>
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>pty<span style="color:#fe8019">.</span>max<span style="color:#fe8019">=</span><span style="color:#d3869b">1024</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#lxc.hook.pre-mount = pre-mount.sh /var/lib/lxc/images/foo.img /var/lib/lxc/foo/rootfs</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#lxc.rootfs.path    = overlayfs:/var/lib/lxc/foo/rootfs:/var/lib/lxc/foo/delta0</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#lxc.rootfs.options = -t squashfs</span>
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>rootfs<span style="color:#fe8019">.</span>path <span style="color:#fe8019">=</span> loop:<span style="color:#fe8019">/</span><span style="color:#fe8019">var</span><span style="color:#fe8019">/</span>lib<span style="color:#fe8019">/</span>lxc<span style="color:#fe8019">/</span>images<span style="color:#fe8019">/</span>netbox<span style="color:#fe8019">-</span>app<span style="color:#fe8019">-</span>zero<span style="color:#fe8019">.</span>img
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>mount<span style="color:#fe8019">.</span>auto <span style="color:#fe8019">=</span> cgroup:mixed proc:mixed sys:mixed
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#lxc.mount.entry=run run tmpfs rw,nodev,relatime,mode=755 0 0</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#lxc.mount.entry=shm dev/shm tmpfs rw,nodev,noexec,nosuid,relatime,mode=1777,create=dir 0 0</span>
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>mount<span style="color:#fe8019">.</span>entry<span style="color:#fe8019">=/</span><span style="color:#fe8019">var</span><span style="color:#fe8019">/</span>lib<span style="color:#fe8019">/</span>lxc<span style="color:#fe8019">/</span>foo<span style="color:#fe8019">/</span>mnt mnt none bind <span style="color:#d3869b">0</span> <span style="color:#d3869b">0</span>
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>net<span style="color:#fe8019">.</span><span style="color:#d3869b">0.</span>type <span style="color:#fe8019">=</span> veth
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>net<span style="color:#fe8019">.</span><span style="color:#d3869b">0.</span>flags <span style="color:#fe8019">=</span> up
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>net<span style="color:#fe8019">.</span><span style="color:#d3869b">0.</span>link <span style="color:#fe8019">=</span> lxcbr0
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#lxc.init.cmd = /sbin/init finit.debug</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#lxc.seccomp.profile = /usr/share/lxc/config/common.seccomp</span>
</span></span><span style="display:flex;"><span>lxc<span style="color:#fe8019">.</span>apparmor<span style="color:#fe8019">.</span>profile <span style="color:#fe8019">=</span> lxc<span style="color:#fe8019">-</span>container<span style="color:#fe8019">-</span>default<span style="color:#fe8019">-</span>with<span style="color:#fe8019">-</span>mounting
</span></span></code></pre></div><p>As can be seen from the example config above, there are many ways to
skin this cat.  This time around are focusing on the uncommented lines
which loop mount the image, mounts a mix of the kernel file systems and
a writable directory on <code>/mnt</code> in the container&rsquo;s namespace.  We also
set up basic networking, which will only work if you have the <code>lxcbr0</code>
bridge interface on your host system.</p>
<p>Notice the AppArmor profile used, you my need to extend it with the
following extra permissions at the bottom:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># /etc/apparmor.d/lxc/lxc-default-with-mounting
</span></span><span style="display:flex;"><span>mount fstype=tmpfs,
</span></span><span style="display:flex;"><span>mount fstype=overlay,
</span></span></code></pre></div><p>Reload AppArmor, or restart your system to activate the changes, then we
can start the container with:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo lxc-start -n foo -F
</span></span><span style="display:flex;"><span>● ● ●  NetBox - The Networking Toolbox ═════════════════════════════════
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Mounting filesystems
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Populating device tree
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Restoring system clock <span style="color:#fe8019">(</span>UTC<span style="color:#fe8019">)</span> from RTC
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Initializing random number generator
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Starting System log daemon
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Starting networking
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Starting SSH daemon
</span></span><span style="display:flex;"><span><span style="color:#fe8019">[</span> OK <span style="color:#fe8019">]</span> Calling /etc/rc.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Welcome to Buildroot
</span></span><span style="display:flex;"><span>buildroot login: root
</span></span><span style="display:flex;"><span>                       .--.--.--.-----.-----.-------.-----.----.--------.-----.
</span></span><span style="display:flex;"><span>   Welcome to NetBox   |  |  |  |  -__|__ --|_     _|  -__|   _|        |  _  |
</span></span><span style="display:flex;"><span>    Made by Westermo   |________|_____|_____| |___| |_____|__| |__|__|__|_____|
</span></span><span style="display:flex;"><span>                                                       https://www.westermo.com
</span></span><span style="display:flex;"><span>NetBox 2021.02-r0-206-g0eba0db-dirty -- Feb <span style="color:#d3869b">13</span> 19:25 CET <span style="color:#d3869b">2022</span>
</span></span><span style="display:flex;"><span>Type: <span style="color:#b8bb26">&#39;help&#39;</span> <span style="color:#fe8019">for</span> <span style="color:#fabd2f">help</span> with commands, <span style="color:#b8bb26">&#39;exit&#39;</span> to log out.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@buildroot:~# 
</span></span></code></pre></div><p>Type <code>poweroff</code> to terminate the container.  To start it in the
background, omit <code>-F</code> above, then use <code>lxc-attach</code> to connect (and
disconnect) from it.</p>
      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://troglobit.com/tags/howto/">howto</a></span>
        <span class="tag"><a href="https://troglobit.com/tags/finit/">finit</a></span>
        <span class="tag"><a href="https://troglobit.com/tags/init/">init</a></span>
        <span class="tag"><a href="https://troglobit.com/tags/opensource/">opensource</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        473 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2022-02-13 16:55
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://troglobit.com/post/2022-04-11-linux-kernel-development-checklist/">
                    <span class="button__icon">←</span>
                    <span class="button__text">Linux Kernel Development Checklist</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://troglobit.com/post/2022-01-24-gmail-and-git-send-email/">
                    <span class="button__text">Gmail and git send-email</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

    

  </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2006</span>
            <span><a href="https://troglobit.com/">Joachim Wiberg</a></span>
            <span>UNIX&trade; 4Life! &#9994;</span>
            
            
        </div>
    </div>
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://troglobit.com/bundle.min.46e438bd2eca7eb6358c700b40f6f56b22ab0b92503ecc11a2d8e4bcc610b8b4da83e5ea3d3e84fdb5f3c3c765744b9f5bbaf43cf5a027910be07ee39a9c12a1.js" integrity="sha512-RuQ4vS7KfrY1jHALQPb1ayKrC5JQPswRotjkvMYQuLTag&#43;XqPT6E/bXzw8dldEufW7r0PPWgJ5EL4H7jmpwSoQ=="></script>




    </body>
</html>
