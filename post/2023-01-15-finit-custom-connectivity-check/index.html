<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Joachim Wiberg ">
<meta name="description" content="This post shows how you can extend Finit with your own conditions. The example we will use is a simple Internet connectivity checker. When it triggers we start BusyBox ntpd which, if started with any other type of condition (none, default route, etc.) may get stuck trying to resolve pool.ntp.org.
" />
<meta name="keywords" content=", finit, init, opensource" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://troglobit.com/post/2023-01-15-finit-custom-connectivity-check/" />


    <title>
        
            Finit custom connectivity check :: Joachim Wiberg 
        
    </title>





<link rel="stylesheet" href="https://troglobit.com/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css" integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE=">



    <link rel="apple-touch-icon" sizes="180x180" href="https://troglobit.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://troglobit.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://troglobit.com/favicon-16x16.png">
    <link rel="manifest" href="https://troglobit.com/site.webmanifest">
    <link rel="mask-icon" href="https://troglobit.com/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://troglobit.com/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Finit custom connectivity check">
<meta itemprop="description" content="This post shows how you can extend Finit with your own conditions.  The
example we will use is a simple Internet connectivity checker.  When it
triggers we start BusyBox ntpd which, if started with any other type of
condition (none, default route, etc.) may get stuck trying to resolve
pool.ntp.org."><meta itemprop="datePublished" content="2023-01-15T18:42:00+00:00" />
<meta itemprop="dateModified" content="2023-01-15T18:42:00+00:00" />
<meta itemprop="wordCount" content="488">
<meta itemprop="keywords" content="finit,init,opensource," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Finit custom connectivity check"/>
<meta name="twitter:description" content="This post shows how you can extend Finit with your own conditions.  The
example we will use is a simple Internet connectivity checker.  When it
triggers we start BusyBox ntpd which, if started with any other type of
condition (none, default route, etc.) may get stuck trying to resolve
pool.ntp.org."/>



    <meta property="og:title" content="Finit custom connectivity check" />
<meta property="og:description" content="This post shows how you can extend Finit with your own conditions.  The
example we will use is a simple Internet connectivity checker.  When it
triggers we start BusyBox ntpd which, if started with any other type of
condition (none, default route, etc.) may get stuck trying to resolve
pool.ntp.org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troglobit.com/post/2023-01-15-finit-custom-connectivity-check/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-15T18:42:00+00:00" />
<meta property="article:modified_time" content="2023-01-15T18:42:00+00:00" />







    <meta property="article:published_time" content="2023-01-15 18:42:00 &#43;0000 UTC" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://troglobit.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text ">
                $ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://troglobit.com/about/">About</a></li><li><a href="https://troglobit.com/posts/">Blog</a></li><li><a href="https://troglobit.com/howtos/">HowTos</a></li><li><a href="https://troglobit.com/projects/">Projects</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        3 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://troglobit.com/post/2023-01-15-finit-custom-connectivity-check/">Finit custom connectivity check</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>This post shows how you can extend Finit with your own conditions.  The
example we will use is a simple Internet connectivity checker.  When it
triggers we start BusyBox ntpd which, if started with any other type of
condition (none, default route, etc.) may get stuck trying to resolve
<code>pool.ntp.org</code>.</p>
<h3 id="recap">Recap</h3>
<p>As mentioned in previous posts, the three main condition groups are:</p>
<ul>
<li>pid</li>
<li>net</li>
<li>usr</li>
</ul>
<p>Recently another group has been added:</p>
<ul>
<li>sys</li>
</ul>
<p>It is free to use and populate by users.  Take note, however, of other
plugins and daemons that share the namespace.  For instance, the Finit
<code>keventd</code> publish the <code>&lt;sys/pwr/ac&gt;</code> condition.</p>
<blockquote>
<p>For details see the Finit documentation:
<a href="https://github.com/troglobit/finit/blob/master/doc/conditions.md">https://github.com/troglobit/finit/blob/master/doc/conditions.md</a></p>
</blockquote>
<h3 id="connectivity-check">Connectivity Check</h3>
<p>There are many methods available, ICMP (ping) is probably the most
common.  But since it is often blocked by firewalls we will use plain
HTTP, of which there are several online servers to choose from:</p>
<table>
<thead>
<tr>
<th><strong>URI</strong></th>
<th><strong>Response</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://network-test.debian.org/nm">http://network-test.debian.org/nm</a></td>
<td>NetworkManager is online</td>
</tr>
<tr>
<td><a href="https://fedoraproject.org/static/hotspot.txt">https://fedoraproject.org/static/hotspot.txt</a></td>
<td>OK</td>
</tr>
<tr>
<td><a href="http://nmcheck.gnome.org/check_network_status.txt">http://nmcheck.gnome.org/check_network_status.txt</a></td>
<td>NetworkManager is online</td>
</tr>
<tr>
<td><a href="https://www.pkgbuild.com/check_network_status.txt">https://www.pkgbuild.com/check_network_status.txt</a></td>
<td>NetworkManager is online</td>
</tr>
<tr>
<td><a href="http://connectivity-check.ubuntu.com">http://connectivity-check.ubuntu.com</a></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<p>The Ubuntu checker returns an empty response, making it very simple to
use with a basic <code>curl http://connectivity-check.ubuntu.com</code>.  Simply
checking the return value is enough.</p>
</blockquote>
<h3 id="the-script">The Script</h3>
<p>We don&rsquo;t have curl on our target, only the BusyBox version of wget.  But
that is all we need to create this little script.  I&rsquo;ve put mine in the
rootfs with a post-build hook in Buildroot.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@anarchy:~# cat /usr/bin/connectivity.sh
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">#!/bin/sh</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"># Manages connectivity condition &lt;sys/internet/up&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GEN<span style="color:#fe8019">=</span>/run/finit/cond/reconf
</span></span><span style="display:flex;"><span>NET<span style="color:#fe8019">=</span>/run/finit/cond/sys/internet
</span></span><span style="display:flex;"><span>URI<span style="color:#fe8019">=</span>http://connectivity-check.ubuntu.com
</span></span><span style="display:flex;"><span>SEC<span style="color:#fe8019">=</span><span style="color:#d3869b">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>isup<span style="color:#fe8019">()</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">{</span>
</span></span><span style="display:flex;"><span>	wget -T <span style="color:#d3869b">1</span> -qO- $URI 2&gt;/dev/null <span style="color:#fe8019">||</span> <span style="color:#fe8019">return</span> <span style="color:#d3869b">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#d3869b">0</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p $NET
</span></span><span style="display:flex;"><span><span style="color:#fe8019">while</span> true; <span style="color:#fe8019">do</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> isup; <span style="color:#fe8019">then</span>
</span></span><span style="display:flex;"><span>		ln -sf $GEN $NET/up
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">else</span>
</span></span><span style="display:flex;"><span>		rm -f $NET/up
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">fi</span>
</span></span><span style="display:flex;"><span>	sleep $SEC
</span></span><span style="display:flex;"><span><span style="color:#fe8019">done</span>
</span></span></code></pre></div><h3 id="the-finit-config">The Finit Config</h3>
<p>Create a new Finit config for the connectivity script:</p>
<pre><code>root@anarchy:~# initctl -c edit connectivity
</code></pre>
<p>Paste in the following and exit:</p>
<pre><code># Manages the &lt;net/internet/up&gt; condition
service [2345789] connectivity.sh -- Connectivity monitor
</code></pre>
<p>Enable it:</p>
<pre><code>root@anarchy:~# initctl enable connectivity
</code></pre>
<p>Now edit the BusyBox <code>ntpd</code> config:</p>
<pre><code>root@anarchy:~# initctl edit ntpd
</code></pre>
<p>Change it to the following:</p>
<pre><code>service [2345] log &lt;!sys/internet/up&gt; ntpd -n -l -I eth0 -p pool.ntp.org -- NTP daemon
</code></pre>
<p>This tells Finit to wait for the script&rsquo;s condition and then start ntpd
as a server on eth0, and peer with pool.ntp.org.</p>
<p>Activate all the changes:</p>
<pre><code>root@anarchy:~# initctl reload
</code></pre>
<p>Verify everything has started properly using <code>initctl</code>.  Check the
system log messages for the ntpd progress.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>root@anarchy:~# initctl -p
</span></span><span style="display:flex;"><span>PID   IDENT            STATUS   RUNLEVELS    DESCRIPTION
</span></span><span style="display:flex;"><span>==============================================================================
</span></span><span style="display:flex;"><span>438   connectivity.sh  running  [--2345-789] Connectivity monitor
</span></span><span style="display:flex;"><span>443   dropbear         running  [--2345-789] Dropbear SSH daemon
</span></span><span style="display:flex;"><span>455   tty:console      running  [-12345-789] Getty on /dev/console
</span></span><span style="display:flex;"><span>444   mdnsd            running  [--2345-789] mDNS-SD daemon
</span></span><span style="display:flex;"><span>445   mini-snmpd       running  [--2345----] Mini snmpd
</span></span><span style="display:flex;"><span>8379  ntpd             running  [--2345----] NTP daemon
</span></span><span style="display:flex;"><span>447   smcrouted        running  [--2345----] Static multicast routing daemon
</span></span><span style="display:flex;"><span>448   ssdpd            running  [--2345----] SSDP Responder
</span></span><span style="display:flex;"><span>416   sysklogd         running  [S123456789] System log daemon
</span></span><span style="display:flex;"><span>449   watchdogd        running  [-123456789] System watchdog daemon
</span></span><span style="display:flex;"><span>450   httpd            running  [--2345----] Web interface
</span></span><span style="display:flex;"><span>root@anarchy:~# initctl -p cond
</span></span><span style="display:flex;"><span>PID   IDENT            STATUS  CONDITION (+ ON, ~ FLUX, - OFF)
</span></span><span style="display:flex;"><span>==============================================================================
</span></span><span style="display:flex;"><span>8379  ntpd             on      &lt;+sys/internet/up&gt;
</span></span></code></pre></div>
      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://troglobit.com/tags/finit/">finit</a></span>
        <span class="tag"><a href="https://troglobit.com/tags/init/">init</a></span>
        <span class="tag"><a href="https://troglobit.com/tags/opensource/">opensource</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        488 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2023-01-15 19:42
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://troglobit.com/post/2023-06-04-buildroot-development-checklist/">
                    <span class="button__icon">←</span>
                    <span class="button__text">Buildroot Development Checklist</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://troglobit.com/post/2022-10-01-remap-prev/next-on-thinkpad/">
                    <span class="button__text">Remap Prev/Next on ThinkPad</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

    

  </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2006</span>
            <span><a href="https://troglobit.com/">Joachim Wiberg</a></span>
            <span>UNIX&trade; 4Life! &#9994;</span>
            
            
        </div>
    </div>
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://troglobit.com/bundle.min.46e438bd2eca7eb6358c700b40f6f56b22ab0b92503ecc11a2d8e4bcc610b8b4da83e5ea3d3e84fdb5f3c3c765744b9f5bbaf43cf5a027910be07ee39a9c12a1.js" integrity="sha512-RuQ4vS7KfrY1jHALQPb1ayKrC5JQPswRotjkvMYQuLTag&#43;XqPT6E/bXzw8dldEufW7r0PPWgJ5EL4H7jmpwSoQ=="></script>




    </body>
</html>
