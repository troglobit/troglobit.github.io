<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>HowTo: Set up Merecat with Let&#39;s Encrypt certificate - </title>
  <meta property="og:title" content="HowTo: Set up Merecat with Let&#39;s Encrypt certificate" />
  <meta name="twitter:title" content="HowTo: Set up Merecat with Let&#39;s Encrypt certificate" />
  <meta name="description" content="This is a HowTo for setting up Merecat httpd with Let&rsquo;s
Encrypt HTTPS certificates.
The upcoming v2.32 release of Merecat supports HTTPS as well as
serving more than one Internet port.  This is highly useful for those
who want to serve both HTTPS and HTTP content.

Update: now with support for --webroot and HTTP-01 renewal!
">
  <meta property="og:description" content="This is a HowTo for setting up Merecat httpd with Let&rsquo;s
Encrypt HTTPS certificates.
The upcoming v2.32 release of Merecat supports HTTPS as well as
serving more than one Internet port.  This is highly useful for those
who want to serve both HTTPS and HTTP content.

Update: now with support for --webroot and HTTP-01 renewal!
">
  <meta name="twitter:description" content="This is a HowTo for setting up Merecat httpd with Let&rsquo;s
Encrypt HTTPS certificates.
The upcoming v2.32 release of Merecat supports HTTPS as well as
serving more than one Internet port.  This is …">
  <meta name="author" content="Joachim Nilsson"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "",
    
    "url": "\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "\/2020\/07\/HowTo-Set-up-Merecat-with-Lets-Encrypt-certificate\/",
          "name": "How to set up merecat with let\x27s encrypt certificate"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Joachim Nilsson"
  },
  "headline": "HowTo: Set up Merecat with Let\x27s Encrypt certificate",
  "description" : "This is a HowTo for setting up Merecat httpd with Let\x26rsquo;s Encrypt HTTPS certificates.\nThe upcoming v2.32 release of Merecat supports HTTPS as well as serving more than one Internet port. This is highly useful for those who want to serve both HTTPS and HTTP content.\n Update: now with support for --webroot and HTTP-01 renewal!\n",
  "inLanguage" : "en",
  "wordCount":  597 ,
  "datePublished" : "2020-07-15T14:10:00",
  "dateModified" : "2020-07-15T14:10:00",
  "image" : "\/images\/profile.jpg",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "\/2020\/07\/HowTo-Set-up-Merecat-with-Lets-Encrypt-certificate\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "\/images\/profile.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="HowTo: Set up Merecat with Let&#39;s Encrypt certificate" />
<meta property="og:description" content="This is a HowTo for setting up Merecat httpd with Let&rsquo;s
Encrypt HTTPS certificates.
The upcoming v2.32 release of Merecat supports HTTPS as well as
serving more than one Internet port.  This is highly useful for those
who want to serve both HTTPS and HTTP content.

Update: now with support for --webroot and HTTP-01 renewal!
">
<meta property="og:image" content="/images/profile.jpg" />
<meta property="og:url" content="/2020/07/HowTo-Set-up-Merecat-with-Lets-Encrypt-certificate/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="" />

  <meta name="twitter:title" content="HowTo: Set up Merecat with Let&#39;s Encrypt certificate" />
  <meta name="twitter:description" content="This is a HowTo for setting up Merecat httpd with Let&rsquo;s
Encrypt HTTPS certificates.
The upcoming v2.32 release of Merecat supports HTTPS as well as
serving more than one Internet port.  This is …">
  <meta name="twitter:image" content="/images/profile.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@troglobit" />
  <meta name="twitter:creator" content="@troglobit" />
  <link href='/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="/images/profile.jpg" />
  <meta name="twitter:image" content="/images/profile.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@troglobit" />
  <meta name="twitter:creator" content="@troglobit" />
  <meta property="og:url" content="/2020/07/HowTo-Set-up-Merecat-with-Lets-Encrypt-certificate/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="" />

  <meta name="generator" content="Hugo 0.68.3" />
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title=""><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="/css/syntax.css" /><link rel="stylesheet" href="/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"></a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Archive" href="/archive/">Archive</a>
            </li>
          
        
          
            <li>
              <a title="DEB" href="https://deb.troglobit.com">DEB</a>
            </li>
          
        
          
            <li>
              <a title="FTP" href="https://ftp.troglobit.com">FTP</a>
            </li>
          
        
          
            <li>
              <a title="GIT" href="https://git.troglobit.com">GIT</a>
            </li>
          
        
          
            <li>
              <a title="HowTos" href="/howto/">HowTos</a>
            </li>
          
        
          
            <li>
              <a title="Projects" href="/projects/">Projects</a>
            </li>
          
        
          
            <li>
              <a title="Resumé" href="https://resume.troglobit.com">Resumé</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="" href="/">
            <img class="avatar-img" src="/images/profile.jpg" alt="" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>HowTo: Set up Merecat with Let&#39;s Encrypt certificate</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on July 15, 2020
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Joachim Nilsson
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
	
        <p>This is a HowTo for setting up <a href="https://merecat.troglobit.com">Merecat httpd</a> with <a href="https://letsencrypt.org/">Let&rsquo;s
Encrypt</a> HTTPS certificates.</p>
<p>The upcoming v2.32 release of <a href="https://merecat.troglobit.com">Merecat</a> supports HTTPS as well as
serving more than one Internet port.  This is highly useful for those
who want to serve both HTTPS and HTTP content.</p>
<blockquote>
<p><strong>Update:</strong> now with support for <code>--webroot</code> and HTTP-01 renewal!</p>
</blockquote>
<h2 id="getting-the-source">Getting the Source</h2>
<p>To start with, you need the latest release of <a href="https://merecat.troglobit.com">Merecat</a>.  Note, if you
are reading this before Merecat v2.32 has been released you can use the
latest software from the GitHub master branch.  Note, you need OpenSSL
and a few other packages, see the README file for details:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git clone https://github.com/troglobit/merecat.git
<span style="color:#0086b3">cd</span> merecat/
./autogen.sh
./configure
make package
sudo dpkg -i ../merecat_2.32-1_amd64.deb
</code></pre></div><h2 id="starting-certbot">Starting Certbot</h2>
<p>If you already have at least version v2.32 of <a href="https://merecat.troglobit.com">Merecat</a> installed you
can begin the process of getting a Let&rsquo;s Encrypt certificate.  This
HowTo use the EFF&rsquo;s certbot, which is available in Ubuntu or from the
Let&rsquo;s Encrypt homepage:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Oups, that didn&rsquo;t go as planned &hellip; well, it turns out the version of
certbot in Ubuntu 18.04 lacks support for <em>wildcard certificates</em>.  We
can either go to their homepage and get the latest version, or list all
the domains we need:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The <a href="https://certbot.eff.org/lets-encrypt/ubuntubionic-other">Let&rsquo;s Encrypt setup guide</a> at this point recommends that
we verify that automatic certificate renewal works (cronjob or systemd
timer).  If this doesn&rsquo;t work, your certificate will expire after only
six months!  So let&rsquo;s check that now:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>It is recommended to also set up Diffie-Hellman paramaters.  For this
you need to genereate a site specific file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">root@example:/var/www# openssl dhparam -out certs/dhparam.pem <span style="color:#099">2048</span>
Generating DH parameters, <span style="color:#099">2048</span> bit long safe prime, generator <span style="color:#099">2</span>

This is going to take a long <span style="color:#0086b3">time</span>
........................................................+.........................................................................
.......+......................................+...................................................................................
.............................................................................................+....................................
..................................................................................................................................
......................................................................+...........................................................
............................................................................................................................+.....
..................................................................................................................................
.+.......+........................................................................................................................
.........................+........................................................................................................
.................+.............................................................++*++*++*++*
root@example:/var/www#
</code></pre></div><p>The <code>/etc/merecat.conf</code> file for a site with a couple of virtual hosts,
look like this:</p>
<pre><code class="language-conf" data-lang="conf">## /etc/merecat.conf                                     -*-conf-unix-*-

virtual-host     = true

user-agent-deny  = &quot;**SemrushBot**|**MJ12bot**|**DotBot**&quot;

server default {
    port     = 80
}

server secure {
    port     = 443
    ssl {
        certfile = /etc/letsencrypt/live/example.com/fullchain.pem
        keyfile  = /etc/letsencrypt/live/example.com/privkey.pem
        dhfile   = certs/dhparam.pem
    }
}
</code></pre><p>The <a href="https://merecat.troglobit.com">Merecat</a> defaults take care of a lot of the nasty details you
shouldn&rsquo;t have to bother with, and unlike other web servers the virtual
host setup is done in the file system rather than in the configuration
file.  See <a href="https://merecat.troglobit.com">Merecat</a> docs for details.</p>
<p>With everything set up we can fire it up:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="http-01-renewal">HTTP-01 Renewal</h2>
<p>For automatic renewal to work you need a new (July 2020) feature of
Merecat, called location matching:</p>
<pre><code class="language-conf" data-lang="conf">server default {
        port = 80
        location &quot;/.well-known/acme-challenge/**&quot; {
                 path = &quot;letsencrypt/.well-known/acme-challenge/&quot;
        }
        redirect &quot;/**&quot; {
                 code = 301
                 location = &quot;https://$host$request_uri$args&quot;
        }
}
</code></pre><p>The <code>path</code> must be relative to the server root directory.  Use bind
mounts to get <code>/var/lib/letsencrypt</code> into your server root.  This way
we can ensure <code>certbot</code> only writes to its own directory and cannot
write to any file in the server root.</p>
<p>Then run <code>certbot</code> with the following arguments and then add all virtual
hosts you want to support from Merecat:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@example:/var/www/&gt; certbot certonly --webroot --webroot-path /var/lib/letsencrypt --dry-run
</code></pre></div><p>Drop <code>--dry-run</code> when you&rsquo;re done playing around learning all settings.</p>
<p>The actual renewal is set up automatically by the certbot install as a
cronjob or systemd timer.  Certbot uses the last known method you used
to manually install/update your certs.  For details on this, see the
file <code>/etc/letsencrypt/renewal/example.com.conf</code>.  (Dry runs does not
change this.)</p>
<p>After a successful renewal you need to restart Merecat httpd to activate
the new certificates.  Instead of modifying the above cronjob or timer,
we add the following line to <code>/etc/letsencrypt/cli.ini</code>:</p>
<pre><code class="language-conf" data-lang="conf">deploy-hook = systemctl restart merecat
</code></pre>

        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="/2020/07/Fixing-file-sharing-in-Debian/Ubuntu/Mint/" data-toggle="tooltip" data-placement="top" title="Fixing file sharing in Debian/Ubuntu/Mint">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="/2020/07/Wireguard-and-DNS-Timeout/" data-toggle="tooltip" data-placement="top" title="Wireguard and DNS Timeout">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:troglobit@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/troglobit" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/troglobit" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://troglobit.com">Joachim Nilsson</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.68.3</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="/js/load-photoswipe.js"></script>









  </body>
</html>

