<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Joachim Wiberg">
    <meta name="description" content="This is an introduction to HowTo run pimd on OpenBSD. I keep it around mostly as a reminder to myself when testing new pimd releases, maybe someone else can make use of it as well.
First of all, my sincere thanks to the OpenBSD team for, not just an awesome UNIX distribution, but also for their good taste in shipping a MULTICAST enabled kernel in the base distribution! On both NetBSD and FreeBSD there is a bit of work to get multicast support, which is one of the reasons for my not writing a HowTo for either of them atm.">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HowTo run pimd on OpenBSD"/>
<meta name="twitter:description" content="This is an introduction to HowTo run pimd on OpenBSD. I keep it around mostly as a reminder to myself when testing new pimd releases, maybe someone else can make use of it as well.
First of all, my sincere thanks to the OpenBSD team for, not just an awesome UNIX distribution, but also for their good taste in shipping a MULTICAST enabled kernel in the base distribution! On both NetBSD and FreeBSD there is a bit of work to get multicast support, which is one of the reasons for my not writing a HowTo for either of them atm."/>

    <meta property="og:title" content="HowTo run pimd on OpenBSD" />
<meta property="og:description" content="This is an introduction to HowTo run pimd on OpenBSD. I keep it around mostly as a reminder to myself when testing new pimd releases, maybe someone else can make use of it as well.
First of all, my sincere thanks to the OpenBSD team for, not just an awesome UNIX distribution, but also for their good taste in shipping a MULTICAST enabled kernel in the base distribution! On both NetBSD and FreeBSD there is a bit of work to get multicast support, which is one of the reasons for my not writing a HowTo for either of them atm." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troglobit.com/howto/pimd-on-openbsd/" />
<meta property="article:published_time" content="2015-07-19T00:32:00+02:00" />
<meta property="article:modified_time" content="2015-07-19T00:32:00+02:00" />


    <title>
  HowTo run pimd on OpenBSD · The Last Outpost
</title>

    
      <link rel="canonical" href="https://troglobit.com/howto/pimd-on-openbsd/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://troglobit.com/css/coder.min.9836c03fe5c87d102278a33e86d0591ef36c89b1e17e8e547ebf84c05cee010e.css" integrity="sha256-mDbAP&#43;XIfRAieKM&#43;htBZHvNsibHhfo5Ufr&#43;EwFzuAQ4=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://troglobit.com/css/coder-dark.min.717236c74e0a5208ef73964a9f44c6b443b689a95b270d8b2a40d0c012460dac.css" integrity="sha256-cXI2x04KUgjvc5ZKn0TGtEO2ialbJw2LKkDQwBJGDaw=" crossorigin="anonymous" media="screen" />
      
    

    
      <link rel="stylesheet" href="https://troglobit.com/css/custom.css" />
    

    

    <link rel="icon" type="image/png" href="https://troglobit.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://troglobit.com/favicon.ico" sizes="16x16">

    <link rel="apple-touch-icon" href="https://troglobit.com/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://troglobit.com/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.68.3" />
  </head>

  
  
    
  
  <body class="colorscheme-auto"
        onload=""
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://troglobit.com/">
      The Last Outpost
    </a>
    
      
        <span id="dark-mode-toggle" class="float-right">
          <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
        </span>
      
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/post/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/howto/">HowTos</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://resume.troglobit.com">Resumé</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://ftp.troglobit.com">FTP</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://git.troglobit.com">GIT</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://deb.troglobit.com">DEB</a>
            </li>
          
        
        
        
          <li class="navigation-item separator">
            <span>|</span>
          </li>
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>HowTo run pimd on OpenBSD</h1>
    </header>

    <p>This is an introduction to HowTo run <a href="https://troglobit.com/pimd.html">pimd</a> on OpenBSD.  I
keep it around mostly as a reminder to myself when testing new pimd
releases, maybe someone else can make use of it as well.</p>
<p>First of all, my sincere thanks to the <a href="http://www.openbsd.org">OpenBSD</a>
team for, not just an awesome UNIX distribution, but also for their good
taste in shipping a MULTICAST enabled kernel in the base distribution!
On both NetBSD and FreeBSD <a href="https://troglobit.com/blog/2014/09/23/howto-add-multicast-routing-support-to-the-freebsd-kernel/">there is a bit of work</a> to get multicast
support, which is one of the reasons for my not writing a HowTo for
either of them atm.</p>
<p>Now, OpenBSD already ships mrouted, which is an older flood and prune based
protocol called DVMRP.  Their version is a few years older than the
<a href="https://troglobit.com/mrouted.html">mrouted</a> I maintain.  The DVMRP protocol in mrouted uses a
sort of built-in RIP to figure out how to route multicast.  This was one of
the first things <a href="http://tools.ietf.org/html/rfc2362">they</a> ripped out when
creating PIM.</p>
<p>PIM stands for <em>Protocol Independent Multicast</em>, so you need to run RIP
or OSPF (or BGP or IS-IS) or whatever <em>unicast</em> routing protocol first
so that regular traffic works.  Which is kind of useful since you can
test the network with simple <code>ping</code> before trying to get any multicast
routing to work &hellip;</p>
<!-- raw HTML omitted -->
<p>My topology for testing <code>pimd</code> often looks something like the following.
In this HowTo the OpenBSD router is R3:</p>
<pre><code>.--------.    .----.    .----.    .----.    .----------.
| Sender |----| R1 |----| R2 |----| R3 |----| Receiver |
'--------'    '----'    '----'    '----'    '----------'
</code></pre>
<p>So, starting out with a clean OpenBSD install we begin by setting up the
basics:</p>
<ul>
<li>Activate unicast &amp; multicast routing in the kernel</li>
<li>Enable ripd and set system up as a multicast router</li>
<li>Configure ripd</li>
<li>Download &amp; build pimd</li>
<li>Run pimd</li>
<li>Troubleshooting</li>
</ul>
<h3 id="enable-unicast--multicast-routing-in-the-kernel">Enable Unicast &amp; Multicast Routing in the Kernel</h3>
<pre><code>cp /etc/examples/sysctl.conf /etc/
</code></pre>
<p>Uncomment the following two lines</p>
<pre><code>net.inet.ip.forwarding=1        # 1=Permit forwarding (routing) of IPv4 packets
net.inet.ip.mforwarding=1       # 1=Permit forwarding (routing) of IPv4 multicast packets
</code></pre>
<h3 id="enable-ripd-and-set-system-up-as-multicast-router">Enable ripd and set System up as Multicast Router</h3>
<p>Create the file /etc/rc.conf.local, unless you already have it.  Add the
following lines to enable ripd and enable the use of a multicast routing
daemon:</p>
<pre><code># Enable ripd, also edit /etc/ripd.conf
ripd_flags=&quot;&quot;           # for normal use: &quot;&quot;

# Multicast routing configuration
# Please look at netstart(8) for a detailed description if you change these
multicast_host=NO       # Route all multicast packets to a single interface
multicast_router=YES    # A multicast routing daemon will be run, e.g. mrouted
</code></pre>
<h3 id="configure-ripd">Configure ripd</h3>
<p>Create the file /etc/ripd.conf by using the template</p>
<pre><code>cp /etc/examples/ripd.conf /etc/
</code></pre>
<p>Edit the file and add interface sections to all the interfaces you want
ripd to operate on, or to not operate on.  Here is my <code>ripd.conf</code>:</p>
<pre><code>fib-update yes
redistribute connected
split-horizon poisoned
triggered-updates yes

# Do not use the WAN interface
interface pcn0 {
        passive
}

# This interface is connected to R2
interface pcn1 {
        cost 1
}

# This interface is connected to the client/receiver
interface pcn2 {
        cost 1
}
</code></pre>
<p>Notice how I have <code>redistribute connected</code> instead of the default.</p>
<h3 id="download--build-pimd">Download &amp; Build pimd</h3>
<p>GitHub is the home for pimd development, the latest release is always
available on the <a href="https://github.com/troglobit/pimd/releases">releases</a> page.  For convenience I also provide an
<a href="ftp://ftp.troglobit.com/pimd/">FTP</a>, so it is simple enough to use OpenBSD without any additional
tools.</p>
<pre><code>$ ftp ftp://ftp.troglobit.com/pimd/pimd-2.3.0.tar.gz
$ tar xfz pimd-2.3.0.tar.gz
$ cd pimd-2.3.0/
$ ./configure; make
</code></pre>
<p>You may want to install <code>pimd</code> to your system when done, but you can
also run it from the build directory if you like.  The default install
path is <code>/usr/local/sbin/pimd</code> and <code>/etc/pimd.conf</code>.  Use the <code>--prefix</code>
and <code>--sysconfdir</code> command line options to the configure script to set
other install directories.  See the file <a href="https://github.com/troglobit/pimd/blob/master/INSTALL.md">INSTALL.md</a> for more info.</p>
<p>That&rsquo;s it!</p>
<h3 id="run-pimd">Run pimd</h3>
<p>The default settings in <code>/etc/pimd.conf</code> should work for almost all use
cases, but it is good practise to at least disable PIM on interfaces out
to the Internet, or your local office network.  In my case, like in the
case with ripd above, it is <code>pcn0</code>.</p>
<p>Uncomment and edit the line <code>#phyint eth0 disable</code> in <code>/etc/pimd.conf</code>:</p>
<pre><code>phyint pcn0 disable
</code></pre>
<p>Then you can start pimd:</p>
<pre><code>pimd
</code></pre>
<p>To see what it is doing you can run it in the foreground with the debug
command:</p>
<pre><code>pimd -d
</code></pre>
<p>or if you simply want to see the current state.  Notice how it says
<code>DISABLED</code> on VIF 0, which is <code>pcn0</code>:</p>
<pre><code>pimd -r
Virtual Interface Table ======================================================
Vif  Local Address    Subnet              Thresh  Flags      Neighbors
---  ---------------  ------------------  ------  ---------  -----------------
0  192.168.123.30   192.168.123              1  DISABLED
1  20.30.0.2        20.30/24                 1  DR PIM     20.30.0.1      
2  10.141.1.181     10.141.1/24              1  DR NO-NBR
3  20.30.0.2        register_vif0            1 

Vif  SSM Group        Sources             

Multicast Routing Table ======================================================
----------------------------------- (*,G) ------------------------------------
Source           Group            RP Address       Flags
---------------  ---------------  ---------------  ---------------------------
INADDR_ANY       225.1.2.3        20.30.0.1        WC RP
Joined   oifs: ....                
Pruned   oifs: ....                
Leaves   oifs: ..l.                
Asserted oifs: ....                
Outgoing oifs: ..o.                
Incoming     : .I..                

TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3
0    40     0       0        0  0  0  0
----------------------------------- (S,G) ------------------------------------
Source           Group            RP Address       Flags
---------------  ---------------  ---------------  ---------------------------
10.142.0.145     225.1.2.3        20.30.0.1        CACHE SG
Joined   oifs: ....                
Pruned   oifs: ....                
Leaves   oifs: ..l.                
Asserted oifs: ....                
Outgoing oifs: ..o.                
Incoming     : .I..                

TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3
150     5     0       0        0  0  0  0
--------------------------------- (*,*,G) ------------------------------------
Number of Groups: 1
Number of Cache MIRRORs: 1
------------------------------------------------------------------------------
</code></pre>
<p>You may also want to see what the OpenBSD kernel thinks about the
situation when everything is working:</p>
<pre><code># netstat -g

Virtual Interface Table
Vif  Thresh  Limit  Local-Address    Remote-Address   Pkt_in  Pkt_out
1       1  20.30.0.2                           8052        0
2       1  10.141.1.181                           0     8052
3       1  20.30.0.2                              0        0

Multicast Forwarding Cache
Hash  Origin           Mcastgroup       Traffic  In-Vif  Out-Vifs/Forw-ttl
0  10.142.0.145     225.1.2.3             
  1  2/1

Total no. of entries in cache: 1

IPv6 Multicast Interface Table is empty
IPv6 Multicast Routing Table is empty
</code></pre>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>The number one problem in multicast routing is the TTL of the multicast
stream from the sender.  In this example I use simple <code>ping</code>, but tweak
the TTL and force the output interface:</p>
<pre><code>root@sender:~# ping -I eth1 -t 10 225.1.2.3           # Linux
</code></pre>
<p>The second most common problem is with equipment between the sender or
the receiver and the closes router.  Usually some infrastructure like a
simple switch, or as in the case with virtual setups, a software bridge.
Any one of these semi-intelligent devices can make a mess of your day.
If you suspect trouble, use <code>ping</code> from the receiver (or the sender) and
use <code>tcpdump</code> on the closest router.  You should be able to see the ICMP
frames.  If not, try disabling <em>IGMP snooping</em> on the swithc or software
bridge.  On a Linux <em>host system</em> this is done by:</p>
<pre><code>echo 0 &gt; /sys/devices/virtual/net/virbr*/bridge/multicast_snooping
</code></pre>
<p>The third most common problem is actually the firewall in your system.
On Linux systems you get <code>EPERM</code> &ndash; &ldquo;Operation not permitted&rdquo;, and on
OpenBSD you likely get <code>EHOSTUNREACH</code> &ndash; &ldquo;No route to host&rdquo; all over the
logs, usually for the IGMP traffic that pimd generates.  On OpenBSD this
is due to <code>pf</code> by default filtering all frames with IP options set.  I
added support for the &ldquo;Router Alert&rdquo; IP option to IGMP frames in v2.2.0,
this is recommended per RFC.   Add this to your <code>/etc/pf.conf</code> to allow
IGMP frames to be sent by pimd:</p>
<pre><code># Enable IGMP with Router Alert IP option
pass proto igmp allow-opts
</code></pre>

  </article>
</section>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        ©
        
        2020
         Joachim Wiberg 
      
      
      
    </section>
  </footer>

    </main>

    
      
      <script src="https://troglobit.com/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js"></script>
    

    

    

    

    

    
  </body>

</html>
