<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Joachim Wiberg">
    <meta name="description" content="This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
KVM Installtion,
VirtManager Guide,
the
Ubuntu Server Guide on libvirt,
or
HowtoForge
for that.
Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream Qemu docs
provide a good starting point, as is the original
IBM paper on VirtFS.
For users of Ubuntu &lt;= 13.04, watch out for the
libvirt bug
that I know many people run into, myself included.">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="File System Pass-Through in KVM/Qemu/libvirt"/>
<meta name="twitter:description" content="This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
KVM Installtion,
VirtManager Guide,
the
Ubuntu Server Guide on libvirt,
or
HowtoForge
for that.
Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream Qemu docs
provide a good starting point, as is the original
IBM paper on VirtFS.
For users of Ubuntu &lt;= 13.04, watch out for the
libvirt bug
that I know many people run into, myself included."/>

    <meta property="og:title" content="File System Pass-Through in KVM/Qemu/libvirt" />
<meta property="og:description" content="This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
KVM Installtion,
VirtManager Guide,
the
Ubuntu Server Guide on libvirt,
or
HowtoForge
for that.
Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream Qemu docs
provide a good starting point, as is the original
IBM paper on VirtFS.
For users of Ubuntu &lt;= 13.04, watch out for the
libvirt bug
that I know many people run into, myself included." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troglobit.com/2013/07/05/file-system-pass-through-in-kvm-slash-qemu-slash-libvirt/" />
<meta property="article:published_time" content="2013-07-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2013-07-05T00:00:00+00:00" />


    <title>
  File System Pass-Through in KVM/Qemu/libvirt · The Last Outpost
</title>

    
      <link rel="canonical" href="https://troglobit.com/2013/07/05/file-system-pass-through-in-kvm-slash-qemu-slash-libvirt/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://troglobit.com/css/coder.min.9836c03fe5c87d102278a33e86d0591ef36c89b1e17e8e547ebf84c05cee010e.css" integrity="sha256-mDbAP&#43;XIfRAieKM&#43;htBZHvNsibHhfo5Ufr&#43;EwFzuAQ4=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://troglobit.com/css/coder-dark.min.717236c74e0a5208ef73964a9f44c6b443b689a95b270d8b2a40d0c012460dac.css" integrity="sha256-cXI2x04KUgjvc5ZKn0TGtEO2ialbJw2LKkDQwBJGDaw=" crossorigin="anonymous" media="screen" />
      
    

    
      <link rel="stylesheet" href="https://troglobit.com/css/custom.css" />
    

    

    <link rel="icon" type="image/png" href="https://troglobit.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://troglobit.com/favicon.ico" sizes="16x16">

    <link rel="apple-touch-icon" href="https://troglobit.com/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://troglobit.com/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.68.3" />
  </head>

  
  
    
  
  <body class="colorscheme-auto"
        onload=""
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://troglobit.com/">
      The Last Outpost
    </a>
    
      
        <span id="dark-mode-toggle" class="float-right">
          <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
        </span>
      
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/post/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/howto/">HowTos</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://resume.troglobit.com">Resumé</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://ftp.troglobit.com">FTP</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://git.troglobit.com">GIT</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://deb.troglobit.com">DEB</a>
            </li>
          
        
        
        
          <li class="navigation-item separator">
            <span>|</span>
          </li>
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>File System Pass-Through in KVM/Qemu/libvirt</h1>
    </header>

    <p>This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
<a href="https://help.ubuntu.com/community/KVM/Installation">KVM Installtion</a>,
<a href="https://help.ubuntu.com/community/KVM/VirtManager">VirtManager Guide</a>,
the
<a href="https://help.ubuntu.com/13.04/serverguide/libvirt.html">Ubuntu Server Guide on libvirt</a>,
or
<a href="http://www.howtoforge.com/virtualization-with-kvm-on-ubuntu-12.04-lts-p3">HowtoForge</a>
for that.</p>
<p>Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream <a href="http://wiki.qemu.org/Documentation/9psetup">Qemu docs</a>
provide a good starting point, as is the original
<a href="https://www.kernel.org/doc/ols/2010/ols2010-pages-109-120.pdf">IBM paper on VirtFS</a>.
For users of Ubuntu &lt;= 13.04, watch out for the
<a href="https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/943680">libvirt bug</a>
that I know many people run into, myself included.</p>
<p>First of all, I could never really master the beast called AppArmor in
Ubuntu.  Once I got the hang of the files to edit, the order to make
changes and the syntax of its profile files I think I tried every
possible permutation without any success.  So I ended up disabling the
profile(s) of my VM guests.  The UUID in the filename can be found in
the details of your VM, or in the process listing on the host: <code>ps fax | grep guestname</code>.  Here is an example of how to disable one guest:</p>
<pre><code>aa-complain /etc/apparmor.d/libvirt/libvirt-20b8c6c6-440c-bd76-254e-42fd475e6770
</code></pre>
<p>You need to install <a href="apt://apparmor-utils">apparmor-utils</a> to get the
<code>aa-complain</code> tool.  Where <em>complain</em> basically means ignore any hits
from the given profile and just complain in the log.  The default is
<code>aa-enforce</code>.  For more info on AppArmor, see the
<a href="http://wiki.apparmor.net/index.php/Documentation">excellent upstream docs</a></p>
<!-- raw HTML omitted -->
<p>Now, how to do it.  I like virsh, but for most of the time the vmware
like
<a href="http://virt-manager.org/">virt-manager is a lot more user friendly</a>.
In the VM&rsquo;s Detailed view, click the &ldquo;Add Hardware&rdquo; button and select
&ldquo;Filesystem&rdquo;.  This is where the action happens.</p>
<ul>
<li><strong>Type:</strong> preset to Passthrough</li>
<li><strong>Mode:</strong> change to <code>Mapped</code> <em>This is the most important step in
this blog, or you will not get read/write support!</em></li>
<li><strong>Source path:</strong> select the path on your host that will be shared
with this guest.  I use <code>/var/lib/libvirt/share</code> but you can use any
directory you want</li>
<li><strong>Target path:</strong> enter magic string that you&rsquo;ll use in the mount
command in the guest.  I use <code>share</code>, no slashes or anything.  In
reality this isn&rsquo;t a path per se, it&rsquo;s a tag that the guest sends to
the kernel 9p driver via the mount command</li>
</ul>
<p>Please note that 9P file systems simply pass-through the owner UID/GID
and directory permissions from the host to the guest.  This can be a
bit confusing, but just make sure to use the same for all guests that
share the same directory.  I chowned it to my account on the host:</p>
<pre><code>host# chown jocke:users /var/lib/libvirt/share
</code></pre>
<p>In my <code>guest:/etc/modules</code> I added the following modules, even though
the kernel can probably load them itself on demand:</p>
<pre><code>9p
9pnet
9pnet_virtio
</code></pre>
<p>The actual command to get the ball rolling on the guest:</p>
<pre><code>guest# mount -t 9p -o trans=virtio,version=9p2000.L,rw share /mnt
</code></pre>
<p>To automatically mount this every time at boot, add the following
to your <code>guest:/etc/fstab</code>:</p>
<pre><code>share	/mnt	9p	trans=virtio,version=9p2000.L,rw	0	0
</code></pre>
<p>That&rsquo;s it. Good Luck!</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
  </article>
</section>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        ©
        
        2020
         Joachim Wiberg 
      
      
      
    </section>
  </footer>

    </main>

    
      
      <script src="https://troglobit.com/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js"></script>
    

    

    

    

    

    
  </body>

</html>
