<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Joachim Wiberg ">
<meta name="description" content="This post doesn&amp;rsquo;t cover fully setting up KVM/Qemu with virt-manager and creating virtual machine guests. See the Ubuntu KVM Installtion, VirtManager Guide, the Ubuntu Server Guide on libvirt, or HowtoForge for that.
Instead this blog post details the most relevant steps to get file system pass-through between a Linux host and Qemu guest working. The upstream Qemu docs provide a good starting point, as is the original IBM paper on VirtFS. For users of Ubuntu &amp;lt;= 13.04, watch out for the libvirt bug that I know many people run into, myself included.
" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://troglobit.com/2013/07/05/file-system-pass-through-in-kvm-slash-qemu-slash-libvirt/" />


    <title>
        
            File System Pass-Through in KVM/Qemu/libvirt :: Joachim Wiberg 
        
    </title>





<link rel="stylesheet" href="https://troglobit.com/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css" integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE=">



    <link rel="apple-touch-icon" sizes="180x180" href="https://troglobit.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://troglobit.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://troglobit.com/favicon-16x16.png">
    <link rel="manifest" href="https://troglobit.com/site.webmanifest">
    <link rel="mask-icon" href="https://troglobit.com/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://troglobit.com/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="File System Pass-Through in KVM/Qemu/libvirt">
<meta itemprop="description" content="This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
KVM Installtion,
VirtManager Guide,
the
Ubuntu Server Guide on libvirt,
or
HowtoForge
for that.
Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream Qemu docs
provide a good starting point, as is the original
IBM paper on VirtFS.
For users of Ubuntu &lt;= 13.04, watch out for the
libvirt bug
that I know many people run into, myself included."><meta itemprop="datePublished" content="2013-07-05T00:00:00+00:00" />
<meta itemprop="dateModified" content="2013-07-05T00:00:00+00:00" />
<meta itemprop="wordCount" content="488">
<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="File System Pass-Through in KVM/Qemu/libvirt"/>
<meta name="twitter:description" content="This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
KVM Installtion,
VirtManager Guide,
the
Ubuntu Server Guide on libvirt,
or
HowtoForge
for that.
Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream Qemu docs
provide a good starting point, as is the original
IBM paper on VirtFS.
For users of Ubuntu &lt;= 13.04, watch out for the
libvirt bug
that I know many people run into, myself included."/>



    <meta property="og:title" content="File System Pass-Through in KVM/Qemu/libvirt" />
<meta property="og:description" content="This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
KVM Installtion,
VirtManager Guide,
the
Ubuntu Server Guide on libvirt,
or
HowtoForge
for that.
Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream Qemu docs
provide a good starting point, as is the original
IBM paper on VirtFS.
For users of Ubuntu &lt;= 13.04, watch out for the
libvirt bug
that I know many people run into, myself included." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troglobit.com/2013/07/05/file-system-pass-through-in-kvm-slash-qemu-slash-libvirt/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-07-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2013-07-05T00:00:00+00:00" />





    <meta property="article:section" content="Administration" />

    <meta property="article:section" content="Linux" />



    <meta property="article:published_time" content="2013-07-05 00:00:00 &#43;0000 UTC" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://troglobit.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text ">
                $ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://troglobit.com/about/">About</a></li><li><a href="https://troglobit.com/posts/">Blog</a></li><li><a href="https://troglobit.com/howtos/">HowTos</a></li><li><a href="https://troglobit.com/projects/">Projects</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        3 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://troglobit.com/2013/07/05/file-system-pass-through-in-kvm-slash-qemu-slash-libvirt/">File System Pass-Through in KVM/Qemu/libvirt</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>This post doesn&rsquo;t cover fully setting up KVM/Qemu with virt-manager
and creating virtual machine guests.  See the Ubuntu
<a href="https://help.ubuntu.com/community/KVM/Installation">KVM Installtion</a>,
<a href="https://help.ubuntu.com/community/KVM/VirtManager">VirtManager Guide</a>,
the
<a href="https://help.ubuntu.com/13.04/serverguide/libvirt.html">Ubuntu Server Guide on libvirt</a>,
or
<a href="http://www.howtoforge.com/virtualization-with-kvm-on-ubuntu-12.04-lts-p3">HowtoForge</a>
for that.</p>
<p>Instead this blog post details the most relevant steps to get file
system pass-through between a Linux host and Qemu guest working.  The
upstream <a href="http://wiki.qemu.org/Documentation/9psetup">Qemu docs</a>
provide a good starting point, as is the original
<a href="https://www.kernel.org/doc/ols/2010/ols2010-pages-109-120.pdf">IBM paper on VirtFS</a>.
For users of Ubuntu &lt;= 13.04, watch out for the
<a href="https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/943680">libvirt bug</a>
that I know many people run into, myself included.</p>
<p>First of all, I could never really master the beast called AppArmor in
Ubuntu.  Once I got the hang of the files to edit, the order to make
changes and the syntax of its profile files I think I tried every
possible permutation without any success.  So I ended up disabling the
profile(s) of my VM guests.  The UUID in the filename can be found in
the details of your VM, or in the process listing on the host: <code>ps fax | grep guestname</code>.  Here is an example of how to disable one guest:</p>
<pre><code>aa-complain /etc/apparmor.d/libvirt/libvirt-20b8c6c6-440c-bd76-254e-42fd475e6770
</code></pre>
<p>You need to install <a href="apt://apparmor-utils">apparmor-utils</a> to get the
<code>aa-complain</code> tool.  Where <em>complain</em> basically means ignore any hits
from the given profile and just complain in the log.  The default is
<code>aa-enforce</code>.  For more info on AppArmor, see the
<a href="http://wiki.apparmor.net/index.php/Documentation">excellent upstream docs</a></p>
<img src="https://troglobit.com/images/filesystem-pass-through.png" style="width: 500px; float: right">
<p>Now, how to do it.  I like virsh, but for most of the time the vmware
like
<a href="http://virt-manager.org/">virt-manager is a lot more user friendly</a>.
In the VM&rsquo;s Detailed view, click the &ldquo;Add Hardware&rdquo; button and select
&ldquo;Filesystem&rdquo;.  This is where the action happens.</p>
<ul>
<li><strong>Type:</strong> preset to Passthrough</li>
<li><strong>Mode:</strong> change to <code>Mapped</code> <em>This is the most important step in
this blog, or you will not get read/write support!</em></li>
<li><strong>Source path:</strong> select the path on your host that will be shared
with this guest.  I use <code>/var/lib/libvirt/share</code> but you can use any
directory you want</li>
<li><strong>Target path:</strong> enter magic string that you&rsquo;ll use in the mount
command in the guest.  I use <code>share</code>, no slashes or anything.  In
reality this isn&rsquo;t a path per se, it&rsquo;s a tag that the guest sends to
the kernel 9p driver via the mount command</li>
</ul>
<p>Please note that 9P file systems simply pass-through the owner UID/GID
and directory permissions from the host to the guest.  This can be a
bit confusing, but just make sure to use the same for all guests that
share the same directory.  I chowned it to my account on the host:</p>
<pre><code>host# chown jocke:users /var/lib/libvirt/share
</code></pre>
<p>In my <code>guest:/etc/modules</code> I added the following modules, even though
the kernel can probably load them itself on demand:</p>
<pre><code>9p
9pnet
9pnet_virtio
</code></pre>
<p>The actual command to get the ball rolling on the guest:</p>
<pre><code>guest# mount -t 9p -o trans=virtio,version=9p2000.L,rw share /mnt
</code></pre>
<p>To automatically mount this every time at boot, add the following
to your <code>guest:/etc/fstab</code>:</p>
<pre><code>share	/mnt	9p	trans=virtio,version=9p2000.L,rw	0	0
</code></pre>
<p>That&rsquo;s it. Good Luck!</p>
<!--
  -- Local Variables:
  -- mode: markdown
  -- End:
  -->
      </div>
    </article>

    <hr />

    <div class="post-info">
      
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="https://troglobit.com/categories/administration/">Administration</a></span>
        <span class="tag"><a href="https://troglobit.com/categories/linux/">Linux</a></span>
        
    </p>


      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        488 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2013-07-05 02:00
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://troglobit.com/2013/07/10/net-install-centos/">
                    <span class="button__icon">←</span>
                    <span class="button__text">Net Install CentOS</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://troglobit.com/2013/06/22/programming-as-an-artform/">
                    <span class="button__text">Programming as an Artform</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

    

  </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2006</span>
            <span><a href="https://troglobit.com/">Joachim Wiberg</a></span>
            <span>UNIX&trade; 4Life! &#9994;</span>
            
            
        </div>
    </div>
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://troglobit.com/bundle.min.46e438bd2eca7eb6358c700b40f6f56b22ab0b92503ecc11a2d8e4bcc610b8b4da83e5ea3d3e84fdb5f3c3c765744b9f5bbaf43cf5a027910be07ee39a9c12a1.js" integrity="sha512-RuQ4vS7KfrY1jHALQPb1ayKrC5JQPswRotjkvMYQuLTag&#43;XqPT6E/bXzw8dldEufW7r0PPWgJ5EL4H7jmpwSoQ=="></script>




    </body>
</html>
