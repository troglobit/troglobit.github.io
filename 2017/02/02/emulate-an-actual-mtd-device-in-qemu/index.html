<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Joachim Wiberg ">
<meta name="description" content="Having worked with Linux for the last 20 years, and embedded for more than ten of them, I&amp;rsquo;ve become quite a fan of virtualization in general and Qemu in particular.
Qemu is a fantastic little tool, created by the Open Source superhero Fabrice Bellard. It can be used to verify an embedded system without having to deal with the problems of actual HW until you really have to. Don&amp;rsquo;t get me wrong, HW excites me like any other nerd, but if the HW is new and shaky it can be quite a pain to develop higher level functions.
My holy grail is to have a 100% complete and accurate virtualization target per architecture to test my various software projects on. That&amp;rsquo;s why I created TroglOS.
" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://troglobit.com/2017/02/02/emulate-an-actual-mtd-device-in-qemu/" />


    <title>
        
            Emulate an actual MTD device in Qemu :: Joachim Wiberg 
        
    </title>





<link rel="stylesheet" href="https://troglobit.com/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css" integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE=">



    <link rel="apple-touch-icon" sizes="180x180" href="https://troglobit.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://troglobit.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://troglobit.com/favicon-16x16.png">
    <link rel="manifest" href="https://troglobit.com/site.webmanifest">
    <link rel="mask-icon" href="https://troglobit.com/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="https://troglobit.com/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Emulate an actual MTD device in Qemu">
<meta itemprop="description" content="Having worked with Linux for the last 20 years, and embedded for more
than ten of them, I&rsquo;ve become quite a fan of virtualization in general
and Qemu in particular.
Qemu is a fantastic little tool, created by the Open Source superhero
Fabrice Bellard.
It can be used to verify an embedded system without having to deal with
the problems of actual HW until you really have to.  Don&rsquo;t get me wrong,
HW excites me like any other nerd, but if the HW is new and shaky it can
be quite a pain to develop higher level functions.
My holy grail is to have a 100% complete and accurate virtualization
target per architecture to test my various software projects on.  That&rsquo;s
why I created TroglOS."><meta itemprop="datePublished" content="2017-02-02T18:52:18+00:00" />
<meta itemprop="dateModified" content="2017-02-02T18:52:18+00:00" />
<meta itemprop="wordCount" content="667">
<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Emulate an actual MTD device in Qemu"/>
<meta name="twitter:description" content="Having worked with Linux for the last 20 years, and embedded for more
than ten of them, I&rsquo;ve become quite a fan of virtualization in general
and Qemu in particular.
Qemu is a fantastic little tool, created by the Open Source superhero
Fabrice Bellard.
It can be used to verify an embedded system without having to deal with
the problems of actual HW until you really have to.  Don&rsquo;t get me wrong,
HW excites me like any other nerd, but if the HW is new and shaky it can
be quite a pain to develop higher level functions.
My holy grail is to have a 100% complete and accurate virtualization
target per architecture to test my various software projects on.  That&rsquo;s
why I created TroglOS."/>



    <meta property="og:title" content="Emulate an actual MTD device in Qemu" />
<meta property="og:description" content="Having worked with Linux for the last 20 years, and embedded for more
than ten of them, I&rsquo;ve become quite a fan of virtualization in general
and Qemu in particular.
Qemu is a fantastic little tool, created by the Open Source superhero
Fabrice Bellard.
It can be used to verify an embedded system without having to deal with
the problems of actual HW until you really have to.  Don&rsquo;t get me wrong,
HW excites me like any other nerd, but if the HW is new and shaky it can
be quite a pain to develop higher level functions.
My holy grail is to have a 100% complete and accurate virtualization
target per architecture to test my various software projects on.  That&rsquo;s
why I created TroglOS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troglobit.com/2017/02/02/emulate-an-actual-mtd-device-in-qemu/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-02-02T18:52:18+00:00" />
<meta property="article:modified_time" content="2017-02-02T18:52:18+00:00" />





    <meta property="article:section" content="linux" />

    <meta property="article:section" content="qemu" />

    <meta property="article:section" content="embedded" />



    <meta property="article:published_time" content="2017-02-02 18:52:18 &#43;0000 UTC" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://troglobit.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text ">
                $ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://troglobit.com/about/">About</a></li><li><a href="https://troglobit.com/posts/">Blog</a></li><li><a href="https://troglobit.com/howtos/">HowTos</a></li><li><a href="https://troglobit.com/projects/">Projects</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        4 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://troglobit.com/2017/02/02/emulate-an-actual-mtd-device-in-qemu/">Emulate an actual MTD device in Qemu</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>Having worked with Linux for the last 20 years, and embedded for more
than ten of them, I&rsquo;ve become quite a fan of virtualization in general
and <a href="http://qemu.org">Qemu</a> in particular.</p>
<p>Qemu is a fantastic little tool, created by the Open Source superhero
<a href="http://blog.smartbear.com/careers/fabrice-bellard-portrait-of-a-super-productive-programmer/">Fabrice Bellard</a>.
It can be used to verify an embedded system without having to deal with
the problems of actual HW until you really have to.  Don&rsquo;t get me wrong,
HW excites me like any other nerd, but if the HW is new and shaky it can
be quite a pain to develop higher level functions.</p>
<p>My holy grail is to have a 100% complete and accurate virtualization
target per architecture to test my various software projects on.  That&rsquo;s
why I created <a href="https://github.com/troglobit/troglos">TroglOS</a>.</p>
<p>Since most of the systems I&rsquo;ve engaged with have had built-in (NOR)
flash, I wanted a similar enough emulated system.  However, many things
like RTC or MTD did not really exist or work the way I wanted.  I can
live without an emulated RTC, but mapping <em>named</em> MTD partitions to
different mount points was a showstopper for me.  So one of the small
fixes to Linux I&rsquo;ve made is an extension to the mtd2block driver.</p>
<p>The mtd2block driver can take a device, provided by Qemu emulating a
block device from a raw file on the host, and present as an MTD.  The
following patch adds naming of that MTD so the below <code>/etc/fstab</code> can
find and mount it just like it would an actual named MTD partition.</p>
<p>Here&rsquo;s the <code>/etc/fstab</code> entry:</p>
<pre><code>mtd:Config	/mnt	jffs2	sync,noatime,nodiratime		0	0
</code></pre>
<p>And here&rsquo;s <a href="https://github.com/troglobit/troglos/blob/master/kernel/patches/4.2/mtd2block-custom-label.patch">the patch</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-patch" data-lang="patch"><span style="display:flex;"><span>commit 69f0cbdcfa6a80fbebe206e2bc3e516342da3be8
</span></span><span style="display:flex;"><span>Author: Joachim Nilsson &lt;troglobit@gmail.com&gt;
</span></span><span style="display:flex;"><span>Date:   Wed Nov 18 16:38:13 2015 +0100
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mtd2block: Add support for an optional custom MTD label
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    This patch adds support for an optional MTD label for mtd2block emulated
</span></span><span style="display:flex;"><span>    MTD devices.  Useful when, e.g. testing device images using Qemu.  The
</span></span><span style="display:flex;"><span>    following /etc/fstab line in can then be used to mount a file system
</span></span><span style="display:flex;"><span>    regardless of the actual MTD partition number:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        mtd:Config	/mnt	jffs2	noatime,nodiratime	0    0
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    Kernel command line syntax:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        block2mtd.block2mtd=/dev/sda,,Config
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    The &#39;,,&#39; is the optional erase_size, which like before this patch,
</span></span><span style="display:flex;"><span>    defaults to PAGE_SIZE if left out.
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    Signed-off-by: Joachim Nilsson &lt;troglobit@gmail.com&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">diff --git a/drivers/mtd/devices/block2mtd.c b/drivers/mtd/devices/block2mtd.c
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">index b16f3cd..309276c 100644
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span><span style="color:#282828;background-color:#fb4934">--- a/drivers/mtd/devices/block2mtd.c
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+++ b/drivers/mtd/devices/block2mtd.c
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span><span style="color:#b8bb26;font-weight:bold">@@ -218,7 +218,7 @@ static void block2mtd_free_device(struct block2mtd_dev *dev)
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> static struct block2mtd_dev *add_device(char *devname, int erase_size,
</span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-		int timeout)
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+		char *label, int timeout)
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span> {
</span></span><span style="display:flex;"><span> #ifndef MODULE
</span></span><span style="display:flex;"><span> 	int i;
</span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">@@ -282,7 +282,10 @@ static struct block2mtd_dev *add_device(char *devname, int erase_size,
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span> 
</span></span><span style="display:flex;"><span> 	/* Setup the MTD structure */
</span></span><span style="display:flex;"><span> 	/* make the name contain the block device in */
</span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-	name = kasprintf(GFP_KERNEL, &#34;block2mtd: %s&#34;, devname);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+	if (!label)
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+		name = kasprintf(GFP_KERNEL, &#34;block2mtd: %s&#34;, devname);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+	else
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+		name = kstrdup(label, GFP_KERNEL);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span> 	if (!name)
</span></span><span style="display:flex;"><span> 		goto err_destroy_mutex;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">@@ -383,8 +386,8 @@ static int block2mtd_setup2(const char *val)
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span> 	/* 80 for device, 12 for erase size, 80 for name, 8 for timeout */
</span></span><span style="display:flex;"><span> 	char buf[80 + 12 + 80 + 8];
</span></span><span style="display:flex;"><span> 	char *str = buf;
</span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-	char *token[2];
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-	char *name;
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+	char *token[3];
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+	char *name, *label = NULL;
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span> 	size_t erase_size = PAGE_SIZE;
</span></span><span style="display:flex;"><span> 	unsigned long timeout = MTD_DEFAULT_TIMEOUT;
</span></span><span style="display:flex;"><span> 	int i, ret;
</span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">@@ -397,7 +400,7 @@ static int block2mtd_setup2(const char *val)
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span> 	strcpy(str, val);
</span></span><span style="display:flex;"><span> 	kill_final_newline(str);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-	for (i = 0; i &lt; 2; i++)
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+	for (i = 0; i &lt; 3; i++)
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span> 		token[i] = strsep(&amp;str, &#34;,&#34;);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 	if (str) {
</span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">@@ -416,7 +419,7 @@ static int block2mtd_setup2(const char *val)
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span> 		return 0;
</span></span><span style="display:flex;"><span> 	}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-	if (token[1]) {
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+	if (token[1] &amp;&amp; strlen(token[1])) {
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span> 		ret = parse_num(&amp;erase_size, token[1]);
</span></span><span style="display:flex;"><span> 		if (ret) {
</span></span><span style="display:flex;"><span> 			pr_err(&#34;illegal erase size\n&#34;);
</span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">@@ -424,7 +427,12 @@ static int block2mtd_setup2(const char *val)
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span> 		}
</span></span><span style="display:flex;"><span> 	}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-	add_device(name, erase_size, timeout);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+	if (token[2]) {
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+		label = token[2];
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+		pr_info(&#34;Using custom MTD label &#39;%s&#39; for dev %s\n&#34;, label, name);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+	}
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26">+	add_device(name, erase_size, label, timeout);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span> 
</span></span><span style="display:flex;"><span> 	return 0;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold">@@ -458,7 +466,7 @@ static int block2mtd_setup(const char *val, struct kernel_param *kp)
</span></span></span><span style="display:flex;"><span><span style="color:#b8bb26;font-weight:bold"></span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> module_param_call(block2mtd, block2mtd_setup, NULL, NULL, 0200);
</span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934">-MODULE_PARM_DESC(block2mtd, &#34;Device to use. \&#34;block2mtd=&lt;dev&gt;[,&lt;erasesize&gt;]\&#34;&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#fb4934"></span><span style="color:#282828;background-color:#b8bb26">+MODULE_PARM_DESC(block2mtd, &#34;Device to use. \&#34;block2mtd=&lt;dev&gt;[,[&lt;erasesize&gt;][,&lt;name&gt;]]\&#34;&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#282828;background-color:#b8bb26"></span> 
</span></span><span style="display:flex;"><span> static int __init block2mtd_init(void)
</span></span><span style="display:flex;"><span> {
</span></span></code></pre></div><!--
  -- Local Variables:
  -- mode: markdown
  -- End:
  -->
      </div>
    </article>

    <hr />

    <div class="post-info">
      
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="https://troglobit.com/categories/linux/">linux</a></span>
        <span class="tag"><a href="https://troglobit.com/categories/qemu/">qemu</a></span>
        <span class="tag"><a href="https://troglobit.com/categories/embedded/">embedded</a></span>
        
    </p>


      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        667 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2017-02-02 19:52
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://troglobit.com/2017/02/12/https-proxy-for-merecat-httpd/">
                    <span class="button__icon">←</span>
                    <span class="button__text">HTTPS proxy for Merecat httpd</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://troglobit.com/2017/01/15/wolfenstein-3d-on-retropie/">
                    <span class="button__text">Wolfenstein-3D on RetroPie</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

    

  </main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2006</span>
            <span><a href="https://troglobit.com/">Joachim Wiberg</a></span>
            <span>UNIX&trade; 4Life! &#9994;</span>
            
            
        </div>
    </div>
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="https://troglobit.com/bundle.min.46e438bd2eca7eb6358c700b40f6f56b22ab0b92503ecc11a2d8e4bcc610b8b4da83e5ea3d3e84fdb5f3c3c765744b9f5bbaf43cf5a027910be07ee39a9c12a1.js" integrity="sha512-RuQ4vS7KfrY1jHALQPb1ayKrC5JQPswRotjkvMYQuLTag&#43;XqPT6E/bXzw8dldEufW7r0PPWgJ5EL4H7jmpwSoQ=="></script>




    </body>
</html>
