<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.91ae35f985ba4ae6473b8defee39551f3ce6ed2769fdfa9b3df93f2eac0da4bc.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Troglobit - Multicast HowTo</title>
<meta property="og:title" content=Troglobit&#32;-&#32;Multicast&#32;HowTo />
<meta name="twitter:title" content=Troglobit&#32;-&#32;Multicast&#32;HowTo />
<meta itemprop="name" content=Troglobit&#32;-&#32;Multicast&#32;HowTo />
<meta name="application-name" content=Troglobit&#32;-&#32;Multicast&#32;HowTo />
<meta property="og:site_name" content="Joachim Wiberg" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://troglobit.com/howtos/multicast/" />
<link rel="canonical" href="https://troglobit.com/howtos/multicast/" itemprop="url" />
<meta name="url" content="https://troglobit.com/howtos/multicast/" />
<meta name="twitter:url" content="https://troglobit.com/howtos/multicast/" />
<meta property="og:url" content="https://troglobit.com/howtos/multicast/" />


<meta property="og:updated_time" content="2023-05-28T07:52:12&#43;02:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://troglobit.com/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Joachim Wiberg" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.123.7">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.38582ad6358fd7e8681326fd2f2f83c1056c6fa45c4872e09a3760b866676227.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://troglobit.com/">
                <img src="/images/profile.jpg" alt="brand image">
            </a>
        
        
            <a href="https://troglobit.com/">
                <h1>Troglobit</h1>
            </a>
        
    </h1>
    <p class="lead">
    
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
                
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/post/2024-08-07-buildroot-development-environment/">Buildroot Development Environment</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/post/2024-03-03-building-emacs-with-jit/">Building Emacs with JIT</a>
                            </li>
                        
                    
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/projects/">Projects</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/projects/finit/">Fast init for Linux systems</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/projects/smcroute/">Static Multicast Routing Daemon</a>
                            </li>
                        
                    
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/howtos/">HowTos</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/howtos/snmp/">HowTo play with SNMP</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/howtos/multicast/">Multicast HowTo</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/troglobit">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://www.linkedin.com/in/joachim-wiberg-3a017125">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>















    <a target="_blank" class="social" title="RSS Feed" href="/posts/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>


    <a target="_blank" class="social" title="Email" href="mailto:Joachim%20Wiberg%20%3ctroglobit&#43;spam@gmail.com%3e">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>




        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 Joachim Wiberg. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="https://troglobit.com/howtos/multicast/">Multicast HowTo</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2023-05-28T07:52:12&#43;0200" class="post-date">
        May 28, 2023
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>13 mins read</span>
      </span>
    </div>

    
  </div>

  
  

  
</div>

  <h1 id="introduction">Introduction</h1>
<p>This HowTo attempts to give some insight into the basics of setting up
multicast routing.  Both static multicast routing, with <a href="https://github.com/troglobit/smcroute/" target="_blank">SMCRoute</a>,
and dynamic multicast routing, with <a href="https://github.com/troglobit/mrouted/" target="_blank">mrouted</a> and <a href="https://github.com/troglobit/pimd/" target="_blank">pimd</a>.</p>
<p>For some use-cases, in particular link-local multicast, it may not be
possible to use multicast routing, then I recommend trying out:</p>
<ul>
<li>Bridging networks, see bridge(8) or <a href="https://goyalankit.com/blog/linux-bridge" target="_blank">Linux bridge - how it works</a></li>
<li><a href="http://sourceforge.net/projects/igmpproxy/" target="_blank">igmproxy</a>, <a href="https://github.com/mcproxy/mcproxy" target="_blank">mcproxy</a>, or</li>
<li>OpenVPN in Layer-2, <a href="https://community.openvpn.net/openvpn/wiki/OpenVPNBridging" target="_blank">bridged mode</a></li>
</ul>
<p>Make sure to check out the <a href="#faq">FAQ</a> for the most common problems.</p>
<p>Good Luck! <br />
&ndash; Joachim</p>
<h1 id="basics">Basics</h1>
<p>To understand multicast routing one needs to first understand how
multicast on a LAN works.  In this HowTo the LAN is usually referred to
as Layer-2 and routing (between LANs) as Layer-3.</p>
<h2 id="layer-2-vs-layer-3">Layer-2 vs Layer-3</h2>
<p>First, without any form of regulation multicast is broadcast, which is
inherently bad.  We don&rsquo;t want to route broadcast, but even on a LAN we
want to keep broadcast to a minimum.  Before switches we had hubs which
caused <em>all</em> traffic to be broadcast.  We can do better, not just for
the sake of security but also to increase bandwidth.</p>
<p>Enter IGMP and MLD, the control protocol for multicast on a LAN, for
IPv4 and IPv6 respectively.  Essentially they act as a subscription
based protocol, every N seconds sending out a Query to all nodes on the
LAN; &ldquo;Anyone want multicast?&rdquo;, to which a node can reply; &ldquo;Yes please,
I&rsquo;d like to have 225.1.2.3.&rdquo;.  MLD (IPv6) works in a similar way.</p>
<p>Most managed switches today support <em>IGMP Snooping</em> which is just a
fancy way of saying: this switch does not flood multicast like broadcast
on all ports.  However, it also means that everyone on a LAN that want
multicast have to be able to request it.</p>
<h2 id="multicast-distribution-point">Multicast Distribution Point</h2>
<p>On a LAN with many IGMP Snooping capable switches a <em>Querier election</em>
will take place.  The switch (or router) with the lowest IP address
wins, unless that address is 0.0.0.0.  The elected IGMP querier on a LAN
becomes the <em>distribution point</em> for all multicast.  All other switches
on the LAN must forward both known and unknown multicast to the Querier.</p>
<p>Usually the network IP plan (design) is set in such a way that the
router has the lowest IP address on the LAN, so that it will always
be the elected IGMP querier, hence receiving all multicast so it can
route it as required.</p>
<h2 id="multicast-router-ports">Multicast Router Ports</h2>
<p>In a network with redundant/multiple multicast routers one cannot rely
solely on the IGMP querier election.  Instead, most managed switches
have a setting called <em>Multicast Router Ports</em> where you can configure
on which ports to <em>also</em> flood all multicast.</p>
<p>This feature can also be used to forward multicast to nodes that do not
speak IGMP/MLD.  But since it will forward all multicast it is usually
better to set up static FDB entries per multicast group on the switch
instead.</p>
<blockquote>
<p>Many switches are limited to filtering multicast based on the
<em>multicast MAC</em> equivalent.  In our case of 225.1.2.3 it would be
mapped to 01:00:5e:01:02:03.  For more on this, and the limitations
it brings, see <a href="https://www.ietf.org/rfc/rfc1112.txt" target="_blank">RFC1112</a>.</p>
</blockquote>
<h2 id="pim-sm--igmp-v2-vs-pim-ssm--igmp-v3">PIM-SM :: IGMP v2 vs. PIM-SSM :: IGMP v3</h2>
<p>In the beginning there was darkness and DVMRP conquered the earth.  The
God of all multicast, which is Steve Deering, was pleased.  Then light
came upon us, gods were overthrown and PIM-SM was invented.</p>
<p>The story continues but becomes a bit of a blur because so much happened
in such a short time frame.  There are RFCs that tell the tale better, go
read up on them.  What eventually came out of it was this:</p>
<p>IGMP v2 was an OK protocol, a client requested a group, 225.1.2.3, and
it was unblocked by switches leading up to the Querier and multicast was
received.</p>
<p>PIM-SM was OK, many routers could agree on what groups each of them had,
set up a distribution tree with magic distribution point/routers,
called rendez-vous points (RPs), for one or more, but not necessarily
all multicast groups.  This could be tweaked by hand as well to optimize
distribution.</p>
<p>But what if we had multiple senders for the same group?  A ridiculous
thought at first, but as deployments grew a need for optimizing also
based on the sender (source) grew as well.  Enter PIM-SSM for layer-3
and IGMP v3 on layer-2.  The biggest change is the ability to forward
multicast based on source <em>and</em> group, called (S,G).  An end node on a
LAN could now send an IGMP report requesting (192.168.10.1, 225.1.2.3).</p>
<h2 id="what-is-ttl-and-why-cant-i-route-multicast">What is TTL and Why Can&rsquo;t I Route Multicast?</h2>
<p>The single most common problem with routing multicast that everybody
runs into is the TTL.</p>
<p>The TTL is the <em>Time To Live</em> field in the IP header of a frame.</p>
<pre><code>$ tcpdump -i lo -vvv icmp
tcpdump: listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes
20:36:50.146377 IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.122.1 &gt; 225.1.2.3: ICMP echo request, id 16746, seq 20, length 64
20:36:51.146380 IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.122.1 &gt; 225.1.2.3: ICMP echo request, id 16746, seq 21, length 64
</code></pre>
<p>The TTL for broadcast and multicast is by default 1, which means that a
router should not forward the frame beyond the originating LAN.  Again,
without any regulation multicast is broadcast and we do not want to
route broadcast!</p>
<p>The singular best way to fix this problem is for the sender to set a
higher TTL.  Set it only as high as the number of hops you want this to
be forwarded!</p>
<blockquote>
<p>Multicast is used for A LOT of protocols, many of which was only ever
intended to be either link-local or limited to the LAN.  Check with
the appropriate standard (RFCs are freely available online) before
attempting something foolish that may cause unintended side effects.</p>
</blockquote>
<p>For such cases when you want to connect two remote sites and make them
into one big LAN you might be better off using, e.g. a bridged SSL VPN
on layer-2.</p>
<p>However, when you absolutely cannot change the TTL at the sender and
bridging the two LANs is out of the question, then you can try using
the firewall.  On Linux systems you can <em>mangle</em> matching frames with
the following magic rule(s):</p>
<pre><code>iptables -t mangle -A PREROUTING -d 225.1.2.3 -j TTL --ttl-inc 1
</code></pre>
<p>or, if the sender runs on a system with Linux you can change the frame
as it egresses:</p>
<pre><code>iptables -t mangle -A OUTPUT -d 225.1.2.3 -j TTL --ttl-set 128
</code></pre>
<p>The group can also be a range, so <code>239.0.0.0/8</code> is possible to enter,
and as is shown in these examples, either <code>--ttl-set</code> or <code>--ttl-inc</code> can
be used to adjust the TTL value.</p>
<h2 id="reverse-path-forwarding">Reverse Path Forwarding</h2>
<p>Dynamic multicast routing protocols like DVMRP and PIM-SM rely on
something called <em>Reverse Path Forwarding</em> to build a multicast
distribution tree.</p>
<p>The unicast routing table has the destination in focus, i.e. how to
forward an inbound frame towards the destionation address.</p>
<p>A multicast router builds tables to instead find the reverse path, from
the receiver (who requests multicast) to the source of the multicast
distribution tree.</p>
<p><code>mrouted</code> uses its built-in RIP to construct its distribution tree, and
<code>pimd</code> relies on an external routing protocol like OSPF, RIP, or even a
manually set up routing table on each router.</p>
<p><strong>Note:</strong> A common problem with multicast forwarding on Linux based
routers is <code>rp_filter</code>.  Many systems has this by default set to
&lsquo;strict&rsquo; mode, to protect against DDOS attacks, which may cause major
problems for <code>pimd</code> and <code>mrouted</code>.  If the reverse path to the source
of multicast cannot be determined the frames will be dropped by the
kernel.  See the <a href="#faq">FAQ</a> below for more information.</p>
<h1 id="core-network-simulator">CORE Network Simulator</h1>
<p>These days I do most of my multicast testing with <a href="http://www.nrl.navy.mil/itd/ncs/products/core" target="_blank">CORE</a>, which is
readily available i Debian/Ubuntu as simple as:</p>
<pre><code>sudo apt-get install core-gui
</code></pre>
<p>CORE is very simple to get started with:</p>
<ol>
<li>Fire up the GUI</li>
<li>Drag and drop a few router icons to the grid</li>
<li>Connect them</li>
<li><em>BOOM</em> you now have IP addresses automatically assigned!</li>
<li>Press the Play button &ndash; routers are now starting up</li>
</ol>
<p>Play around a bit to try it out, it&rsquo;s awesome!  I usually start <code>pimd</code>,
<code>mrouted</code>, and <code>smcroute</code> manually with a script.  (You can access the
shell of each router by right-clicking on them.)  The host file system
is reachable from each router in CORE, even though they are isolated and
have their own <a href="http://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/" target="_blank">network namespaces</a>.</p>
<p>For more info on network simulation, like the equally awesome <a href="http://www.gns3.com/" target="_blank">GNS3</a>
for instance, see <a href="http://www.brianlinkletter.com/open-source-network-simulators/" target="_blank">Brian Linkletter&rsquo;s Reviews</a>.</p>
<p><a name="roll-your-own"></a></p>
<h1 id="roll-your-own-cloud">Roll your own Cloud</h1>
<p>The below setup is done using four Ubuntu 12.04 LTS virtual machines
running the linux-virtual kernel package.  In the HowTo I mention both
<a href="/pimd.html">pimd</a> and <a href="/mrouted.html">mrouted</a>, since they work
out-of-the-box w/o any config changes, but you could just as easily
use <a href="/smcroute.html">SMCRoute</a> for the same purpose.</p>
<p>When setting up virtual machines and virtual networking there are many
pitfalls and several requirements for the host to consider.  The most
important one, that needs pointing out, is a <em>bug in the IGMP snooping
code</em> in the Linux bridging code: the bridge handles the special case
<code>224.0.0.*</code> well, but all unknown multicast streams outside of that
segment should also be forwarded as-is to all multicast routers.  Since
this does not work with the current IGMP snooping code in the Linux 3.13
kernel bridge code you must disable snooping:</p>
<pre><code>host# echo 0 &gt; /sys/devices/virtual/net/virbr1/bridge/multicast_snooping
host# echo 0 &gt; /sys/devices/virtual/net/virbr2/bridge/multicast_snooping
host# echo 0 &gt; /sys/devices/virtual/net/virbr3/bridge/multicast_snooping
</code></pre>
<p>Disabling IGMP snooping on the hosts&rsquo; <code>virbr3</code> is not really necessary,
but is done anyway for completeness, and also because I re-use the
same setup in other test cases as well.</p>
<blockquote>
<p>It is of course not recommended to disable IGMP snooping on a bridge,
but if it&rsquo;s buggy you really don&rsquo;t have a choice.  Please check this
for yourself since it depends on the kernel you run.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    R1                        R2                        R3                        R4
</span></span><span style="display:flex;"><span>.--------.                .--------.                .--------.                .--------.
</span></span><span style="display:flex;"><span>|eth0    | 172.16.12.0/24 |eth0    | 172.16.10.0/24 |eth0    |  10.1.0.0/24   |eth0    |
</span></span><span style="display:flex;"><span>|      .1|----------------|.2    .1|----------------|.2    .1|----------------|.2      |
</span></span><span style="display:flex;"><span>|    eth1|     virbr1     |    eth1|     virbr2     |    eth1|    virbr3      |        |
</span></span><span style="display:flex;"><span>&#39;--------&#39;                &#39;--------&#39;                &#39;--------&#39;                &#39;--------&#39;
</span></span></code></pre></div><p>This setup, or
<a href="ftp://ftp.troglobit.com/pimd/lab-network.svg">another more advanced</a>,
can be used for trying out SMCRoute, pimd and mrouted.  Remember there
is only one multicast routing socket, so for each router (Rn) you have
to choose one of:</p>
<ol>
<li><code>pimd -c pimd.conf</code></li>
<li><code>mrouted -c mrouted.conf</code></li>
<li><code>smcroute -f smcroute.conf</code></li>
</ol>
<p>The default configuration files delivered with <code>pimd</code> and <code>mrouted</code>
usually suffice, see their respective manual pages or the comments in
each <code>.conf</code> file for help.</p>
<p>When you start <code>mrouted</code>, you&rsquo;re usually ready to go immediately.  But
in the case of <code>pimd</code>, wait for routers to peer.  Then you can test your
setup using multicast <code>ping</code> from R1 to a <code>tcpdump</code> on R4:</p>
<pre><code>R1# ping -I eth1 -t 3 225.1.2.3
R4# tcpdump -i eth0
</code></pre>
<p>As soon as the PIM routers R2 and R3 have peered you should start seeing
ICMP traffic reaching R4.  If you don&rsquo;t, then check the underlying
routing protocol, e.g. RIP or OSPF, to make sure the <em>reverse path</em> is
known &ndash; this is required for PIM since, unlike DVMRP (<code>mrouted</code>) which
sort of has RIP built-in, PIM relies on a unicast routing protocol to
have populated the routing table.</p>
<p>Now, to the actual test case.  The first command for R1 adds a route for
all multicast packets, that is necessary for all tools where you cannot
set the outbound interface for the multicast stream, in our case
<code>iperf</code>.</p>
<pre><code>R1# ip route add 224.0.0.0/4 dev eth1
R1# iperf -u -c 225.1.2.3 -T 3
R4# iperf -s -u -B 225.1.2.3
</code></pre>
<p>The <code>-T</code> option is important since it tells <code>iperf</code> to raise the TTL to
3, the default TTL for multicast is otherwise 1 due to its broadcast
like nature.</p>
<p>The desired output from <code>iperf</code> is as follows:</p>
<pre><code>R1# iperf -u -c 225.1.2.3 -T 3
------------------------------------------------------------
Client connecting to 225.1.2.3, UDP port 5001
Sending 1470 byte datagrams
Setting multicast TTL to 3
UDP buffer size:  160 KByte (default)
------------------------------------------------------------
[  3] local 172.16.12.1 port 55731 connected with 225.1.2.3 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-10.0 sec  1.25 MBytes  1.05 Mbits/sec
[  3] Sent 893 datagrams

R4# iperf -s -u -B 225.1.2.3
------------------------------------------------------------
Server listening on UDP port 5001
Binding to local address 225.1.2.3
Joining multicast group  225.1.2.3
Receiving 1470 byte datagrams
UDP buffer size:  160 KByte (default)
------------------------------------------------------------
[  3] local 225.1.2.3 port 5001 connected with 172.16.12.1 port 55731
[ ID] Interval       Transfer     Bandwidth        Jitter   Lost/Total Datagrams
[  3]  0.0-10.0 sec  1.25 MBytes  1.05 Mbits/sec   0.268 ms    0/  893 (0%)
</code></pre>
<p>To achieve the same using <a href="/smcroute.html">SMCRoute</a> you need to setup
the multicast routing rules manually.  The easiest way to do this is to
update <code>/etc/smcroute.conf</code> and and start/restart <code>smcroute</code>, or send
<code>SIGHUP</code> to an already running daemon.  The below example makes use of
the source-less (*,G) approach, since we in our limited setup have full
control over all multicast senders.  There is a slight setup cost
associated with this: the time it takes the kernel to notify SMCRoute
about a new source and before the actual multicast route is written to
the kernel.  In most cases this is acceptable.</p>
<p>In <code>smcroute.conf</code> on R2:</p>
<pre><code>mgroup from eth0 group 225.1.2.3
mroute from eth0 group 225.1.2.3 to eth1
</code></pre>
<p>In <code>smcroute.conf</code> on R3:</p>
<pre><code>mgroup from eth0 group 225.1.2.3
mroute from eth0 group 225.1.2.3 to eth1
</code></pre>
<p>Now, start <code>smcroute</code> on each of R2 and R4 and then proceed to start
iperf on R4 and R1, as described above. You should get the same result
as with <code>mrouted</code> and <code>pimd</code>.</p>
<p>That&rsquo;s it. Have fun!</p>
<h1 id="faq">FAQ</h1>
<ol>
<li>
<p><em>It doesn&rsquo;t work?</em></p>
<p>Check the TTL.</p>
</li>
<li>
<p><em>Why does the TTL in multicast default to 1?</em></p>
<p>Because multicast is classified as broadcast, which inherently is
dangerous.  Without proper limitation, like switches with support for
IGMP Snooping, multicast IS broadcast.</p>
</li>
<li>
<p><em>I cannot change the TTL of the multicast sender, what can I do?!</em></p>
<p>Ouch, then you may have to use some firewall mangling technique.
Here is how you could do it on Linux with iptables:</p>
<pre><code> iptables -t mangle -A PREROUTING -d GROUP[/LEN] -j TTL --ttl-set 64
</code></pre>
<p>Where <code>GROUP</code> is the multicast group address of the stream you want
to change the TTL of, with an optional prefix length <code>LEN</code> if you want
to specify a range of groups.  From this <a href="http://www.redhat.com/archives/linux-cluster/2007-September/msg00150.html" target="_blank">RedHat mailing list entry</a>.</p>
</li>
<li>
<p><em>I want to use the loopback interface, but it doesn&rsquo;t show in <code>pimd</code>?</em></p>
<p>Some interfaces, like <code>lo</code> or <code>tunN</code>, do not have the <code>MULTICAST</code>
interface flag set by default.  It should work if you enable it:</p>
<pre><code> ip link set lo multicast on
 ip link set tun1 multicast on
</code></pre>
</li>
<li>
<p><em>It still doesn&rsquo;t work?!</em></p>
<p>Check your network topology, maybe a switch between the sender and
the receiver doesn&rsquo;t properly support IGMP snooping.</p>
<p>For virtual/cloud setups, see above for disabling IGMP snooping
entirely in the Linux kernel bridge.</p>
</li>
<li>
<p><em>The PIM routers seem to have peered, and they list the multicast
groups I want to forward, the TTL is OK, but I see no traffic?</em></p>
<p>Could be your underlying routing protocol (RIP/OSPF) does not know
the reverse path to the source.  Make sure the sender&rsquo;s network is
listed in the routing table on the receiving sides routing table.</p>
<p>Also, on Linux you might get bitten by the <code>rp_filter</code>.  It can be
modified in your system <code>/etc/sysctl.conf</code> file.  Check it with:</p>
<pre><code> # sysctl -ar '\.rp_filter'
 net.ipv4.conf.all.rp_filter = 0
 net.ipv4.conf.default.rp_filter = 0
 net.ipv4.conf.eth0.rp_filter = 0
 net.ipv4.conf.eth1.rp_filter = 0
 net.ipv4.conf.lo.rp_filter = 1
 net.ipv4.conf.pimreg.rp_filter = 0
</code></pre>
<p><a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank">https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt</a></p>
</li>
<li>
<p><em>What&rsquo;s the routing performance of <code>pimd</code>/<code>mrouted</code>/<code>smcroute</code>?</em></p>
<p>N/A.  Neither of them take active part in the actual forwarding of
multicast frames.  This is what the kernel or dedicated routing HW
does.  The routing daemons <code>pimd</code>/<code>mrouted</code>/<code>smcroute</code> only
manipulate the multicast routing table(s) of the operating system&rsquo;s
kernel.</p>
</li>
<li>
<p><em>Do you have any example of how to set up GRE and <code>pimd</code>?</em></p>
<p>Yes, for all the gory details see
<a href="/blog/2016/07/05/multicast-routing-with-pim-sm-over-gre/">this howto</a></p>
</li>
</ol>

  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://troglobit.com/howtos/merecat-and-cgit/?ref=footer"><span style="font-weight:bold;">« Previous</span><br>HowTo: Set up Merecat with cgit</a>
        
	    
            <div class="next-post">
                <a href="https://troglobit.com/howtos/snmp/?ref=footer"><span style="font-weight:bold;">Next »</span><br>HowTo play with SNMP</a>
            </div>
        
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#layer-2-vs-layer-3">Layer-2 vs Layer-3</a></li>
    <li><a href="#multicast-distribution-point">Multicast Distribution Point</a></li>
    <li><a href="#multicast-router-ports">Multicast Router Ports</a></li>
    <li><a href="#pim-sm--igmp-v2-vs-pim-ssm--igmp-v3">PIM-SM :: IGMP v2 vs. PIM-SSM :: IGMP v3</a></li>
    <li><a href="#what-is-ttl-and-why-cant-i-route-multicast">What is TTL and Why Can&rsquo;t I Route Multicast?</a></li>
    <li><a href="#reverse-path-forwarding">Reverse Path Forwarding</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
