<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Joachim Wiberg">
    <meta name="description" content="The other day I got my geeky hands on two old SuperMicro X8STI-F 1U
servers.  I plan to use them as build and embedded target emulation
servers for my open source projects
as well as Minecraft server for my kids :)
">
    <meta name="keywords" content="blog,developer,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fake RAID Adventures"/>
<meta name="twitter:description" content="The other day I got my geeky hands on two old SuperMicro X8STI-F 1U
servers.  I plan to use them as build and embedded target emulation
servers for my open source projects
as well as Minecraft server for my kids :)
"/>

    <meta property="og:title" content="Fake RAID Adventures" />
<meta property="og:description" content="The other day I got my geeky hands on two old SuperMicro X8STI-F 1U
servers.  I plan to use them as build and embedded target emulation
servers for my open source projects
as well as Minecraft server for my kids :)
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://troglobit.com/2016/08/13/fake-raid-adventures/" />
<meta property="article:published_time" content="2016-08-13T15:59:36+00:00" />
<meta property="article:modified_time" content="2016-08-13T15:59:36+00:00" />


    <title>
  Fake RAID Adventures · The Last Outpost
</title>

    
      <link rel="canonical" href="https://troglobit.com/2016/08/13/fake-raid-adventures/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://troglobit.com/css/coder.min.9836c03fe5c87d102278a33e86d0591ef36c89b1e17e8e547ebf84c05cee010e.css" integrity="sha256-mDbAP&#43;XIfRAieKM&#43;htBZHvNsibHhfo5Ufr&#43;EwFzuAQ4=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://troglobit.com/css/coder-dark.min.717236c74e0a5208ef73964a9f44c6b443b689a95b270d8b2a40d0c012460dac.css" integrity="sha256-cXI2x04KUgjvc5ZKn0TGtEO2ialbJw2LKkDQwBJGDaw=" crossorigin="anonymous" media="screen" />
      
    

    
      <link rel="stylesheet" href="https://troglobit.com/css/custom.css" />
    

    

    <link rel="icon" type="image/png" href="https://troglobit.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://troglobit.com/favicon.ico" sizes="16x16">

    <link rel="apple-touch-icon" href="https://troglobit.com/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://troglobit.com/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.68.3" />
  </head>

  
  
    
  
  <body class="colorscheme-auto"
        onload=""
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://troglobit.com/">
      The Last Outpost
    </a>
    
      
        <span id="dark-mode-toggle" class="float-right">
          <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
        </span>
      
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/post/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/howto/">HowTos</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://troglobit.com/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://resume.troglobit.com">Resumé</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://ftp.troglobit.com">FTP</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://git.troglobit.com">GIT</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://deb.troglobit.com">DEB</a>
            </li>
          
        
        
        
          <li class="navigation-item separator">
            <span>|</span>
          </li>
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Fake RAID Adventures</h1>
    </header>

    <p>The other day I got my geeky hands on two old SuperMicro X8STI-F 1U
servers.  I plan to use them as build and embedded target emulation
servers for my <a href="https://github.com/troglobit">open source projects</a>
as well as Minecraft server for my kids :)</p>
<!-- raw HTML omitted -->
<p>During the install of Ubuntu Server 16.04 I realized I wanted try to use
the Intel PCH &ldquo;Fake Raid&rdquo; on the two 1 TB disks, RAID-1.  The support
Intel has in Linux and <code>mdadm</code> for their southbridge RAID controller is
really excellent!</p>
<p>I&rsquo;m not so sure though about the level of support that Debian/Ubuntu and
systemd have for RAID controllers though.  I&rsquo;ve run into problems with
how to shutdown, reboot, and power-off the servers with the RAID.</p>
<p>So far I&rsquo;ve made out that it is possible to power-off the servers with
the power button, but only straight after boot!  To make matters worse
it doesn&rsquo;t seem that Ubuntu sets the IMSM controller in &ldquo;idle&rdquo; state
when rebooting, so unmount (remount ro) fails.  I <em>think</em> this is the
recommended way:</p>
<pre><code>echo idle &gt; /sys/block/md127/md/sync_action
</code></pre>
<p>&hellip; for all the <code>md</code> devices found by globbing <code>/sys/block/md*</code> &hellip;</p>
<p>And then wait for state to become idle before unmounting and remounting
<code>/</code> read-only, as you have to do, but that doesn&rsquo;t seem to be done, so
when the system is booted again it always comes up in a degraded state
:-/</p>
<p>Anyhow, this little adventure taught me a few tricks worth remembering.</p>
<h3 id="show-status-of-intel-container">Show status of Intel Container</h3>
<p>This command lists member arrays and disks used in the container:</p>
<pre><code>user@example:~$ sudo mdadm -D /dev/md/imsm0
</code></pre>
<p>This command details RAID (firmware) capabilities:</p>
<pre><code>user@example:~$ sudo mdadm --detail-platform
       Platform : Intel(R) Matrix Storage Manager
        Version : 8.9.1.1002
    RAID Levels : raid0 raid1 raid10 raid5
    Chunk Sizes : 4k 8k 16k 32k 64k 128k
    2TB volumes : supported
      2TB disks : not supported
      Max Disks : 6
    Max Volumes : 2 per array, 4 per controller
 I/O Controller : /sys/devices/pci0000:00/0000:00:1f.2 (SATA)
</code></pre>
<h3 id="remove-a-disk-from-a-container">Remove a disk from a container</h3>
<p>Say disk <code>/dev/sda</code> is unhealthy in any of the member volumes, fail it
in all volumes, remove it, and zero out the superblock to re-add:</p>
<pre><code>user@example:~$ sudo mdadm /dev/md/Boot -f /dev/sda
user@example:~$ sudo mdadm /dev/md/Root -f /dev/sda
user@example:~$ sudo mdadm /dev/md/imsm0 -r /dev/sda
user@example:~$ sudo mdadm --zero-superblock --force /dev/sda
user@example:~$ sudo mdadm /dev/md/imsm0 -a /dev/sda
</code></pre>
<p>Here <code>Root</code> and <code>Boot</code> are my member volumes in the Intel PCH <code>imsm0</code>
container.  I use a small <code>Boot</code> partition for <code>/boot</code>, first partition
on the array, to be able to boot using GRUB from it.</p>
<p>If the above doesn&rsquo;t work for you (it didn&rsquo;t for me), try zeroing out
the complete device, which naturally will take a while, try smaller
blocksize (bs) if the following does not work:</p>
<pre><code>user@example:~$ sudo dd if=/dev/zero of=/dev/sda bs=100M
</code></pre>
<p>Then reboot and tell the Intel firmware (Ctrl-I maybe) at POST to add
the &ldquo;new&rdquo; disk to the array, or rather to the <em>container</em> to be correct.
When booting up the system again, Linux starts a background rebuild.</p>
<h3 id="check-satus-of-raid">Check satus of RAID</h3>
<p>Check progress of the rebuild with:</p>
<pre><code>user@example:~$ cat /proc/mdstat
Personalities : [raid1] [linear] [multipath] [raid0] [raid6] [raid5] [raid4] [raid10] 
md125 : active raid1 sda[1] sdb[0]
      2097152 blocks super external:/md127/0 [2/1] [_U]
        resync=DELAYED
      
md126 : active raid1 sda[1] sdb[0]
      974660608 blocks super external:/md127/1 [2/1] [_U]
  [===&gt;.................]  recovery = 17.5% (171137152/974660740) finish=103.4min speed=129396K/sec
          
md127 : inactive sda[1](S) sdb[0](S)
      5024 blocks super external:imsm
           
unused devices: &lt;none&gt;
</code></pre>
<p>Which is very useful with the <code>watch</code> command!</p>
<p>Good Luck!</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
  </article>
</section>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        ©
        
        2020
         Joachim Wiberg 
      
      
      
    </section>
  </footer>

    </main>

    
      
      <script src="https://troglobit.com/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js"></script>
    

    

    

    

    

    
  </body>

</html>
