<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.91ae35f985ba4ae6473b8defee39551f3ce6ed2769fdfa9b3df93f2eac0da4bc.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Troglobit - Multicast routing with PIM-SM over GRE</title>
<meta property="og:title" content=Troglobit&#32;-&#32;Multicast&#32;routing&#32;with&#32;PIM-SM&#32;over&#32;GRE />
<meta name="twitter:title" content=Troglobit&#32;-&#32;Multicast&#32;routing&#32;with&#32;PIM-SM&#32;over&#32;GRE />
<meta itemprop="name" content=Troglobit&#32;-&#32;Multicast&#32;routing&#32;with&#32;PIM-SM&#32;over&#32;GRE />
<meta name="application-name" content=Troglobit&#32;-&#32;Multicast&#32;routing&#32;with&#32;PIM-SM&#32;over&#32;GRE />
<meta property="og:site_name" content="Joachim Wiberg" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://troglobit.com/2016/07/05/multicast-routing-with-pim-sm-over-gre/" />
<link rel="canonical" href="https://troglobit.com/2016/07/05/multicast-routing-with-pim-sm-over-gre/" itemprop="url" />
<meta name="url" content="https://troglobit.com/2016/07/05/multicast-routing-with-pim-sm-over-gre/" />
<meta name="twitter:url" content="https://troglobit.com/2016/07/05/multicast-routing-with-pim-sm-over-gre/" />
<meta property="og:url" content="https://troglobit.com/2016/07/05/multicast-routing-with-pim-sm-over-gre/" />


<meta property="og:updated_time" content="2018-01-23T20:39:36Z" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://troglobit.com/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



  
    <meta name="twitter:site" content="@troglobit" />
    <meta name="twitter:creator" content="@troglobit" />

<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Joachim Wiberg" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.123.7">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.38582ad6358fd7e8681326fd2f2f83c1056c6fa45c4872e09a3760b866676227.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="dark-theme">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://troglobit.com/">
                <img src="/images/profile.jpg" alt="brand image">
            </a>
        
        
            <a href="https://troglobit.com/">
                <h1>Troglobit</h1>
            </a>
        
    </h1>
    <p class="lead">
    
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
                
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/post/2024-08-07-buildroot-development-environment/">Buildroot Development Environment</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/post/2024-03-03-building-emacs-with-jit/">Building Emacs with JIT</a>
                            </li>
                        
                    
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
            
                
                
            
                
                
                    <li class="heading">
                        <a href="/projects/">Projects</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/projects/finit/">Fast init for Linux systems</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/projects/smcroute/">Static Multicast Routing Daemon</a>
                            </li>
                        
                    
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/howtos/">HowTos</a>
                    </li>
                    
                        <li class="sub-heading">
                            
                        </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/howtos/snmp/">HowTo play with SNMP</a>
                            </li>
                        
                            <li class="bullet">
                                <a href="https://troglobit.com/howtos/multicast/">Multicast HowTo</a>
                            </li>
                        
                    
                
            
                
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/troglobit">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://www.linkedin.com/in/joachim-wiberg-3a017125">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="X" href="https://x.com/troglobit">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 512 472.799">
            <path fill="currentColor" d="M403.229 0h78.506L310.219 196.04 512 462.799H354.002L230.261 301.007 88.669 462.799h-78.56l183.455-209.683L0 0h161.999l111.856 147.88L403.229 0zm-27.556 415.805h43.505L138.363 44.527h-46.68l283.99 371.278z"/>
        </svg>
    </a>



    <a target="_blank" class="social" rel="me" title="Mastodon" href="https://fosstodon.org/@troglobit">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M20.94 14c-.28 1.41-2.44 2.96-4.97 3.26c-1.31.15-2.6.3-3.97.24c-2.25-.11-4-.54-4-.54v.62c.32 2.22 2.22 2.35 4.03 2.42c1.82.05 3.44-.46 3.44-.46l.08 1.65s-1.28.68-3.55.81c-1.25.07-2.81-.03-4.62-.5c-3.92-1.05-4.6-5.24-4.7-9.5l-.01-3.43c0-4.34 2.83-5.61 2.83-5.61C6.95 2.3 9.41 2 11.97 2h.06c2.56 0 5.02.3 6.47.96c0 0 2.83 1.27 2.83 5.61c0 0 .04 3.21-.39 5.43M18 8.91c0-1.08-.3-1.91-.85-2.56c-.56-.63-1.3-.96-2.23-.96c-1.06 0-1.87.41-2.42 1.23l-.5.88l-.5-.88c-.56-.82-1.36-1.23-2.43-1.23c-.92 0-1.66.33-2.23.96C6.29 7 6 7.83 6 8.91v5.26h2.1V9.06c0-1.06.45-1.62 1.36-1.62c1 0 1.5.65 1.5 1.93v2.79h2.07V9.37c0-1.28.5-1.93 1.51-1.93c.9 0 1.35.56 1.35 1.62v5.11H18V8.91Z"/>
        </svg>
    </a>











    <a target="_blank" class="social" title="RSS Feed" href="/posts/index.xml">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280.000000 1280.000000">
            <g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentColor">
                <path d="M2295 11929 c-284 -12 -642 -45 -707 -65 -17 -5 -18 -63 -18 -1039 0 -569 4 -1036 8 -1039 5 -3 74 6 153 19 510 86 1168 95 1789 25 1348 -153 2602 -677 3670 -1531 385 -308 820 -744 1126 -1129 842 -1060 1362 -2313 1514 -3650 70 -621 61 -1279 -25 -1789 -13 -79 -22 -148 -19 -153 3 -4 471 -8 1039 -8 l1035 0 5 23 c51 225 85 942 67 1419 -23 605 -77 1044 -198 1617 -294 1400 -927 2734 -1823 3846 -1043 1295 -2364 2259 -3909 2854 -1158 447 -2451 656 -3707 600z"/>
                <path d="M2255 7845 c-269 -25 -620 -81 -667 -106 -17 -9 -18 -55 -18 -899 0 -706 3 -890 13 -890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207 -107 2267 -823 2814 -1902 166 -327 268 -637 330 -1001 38 -227 48 -384 42 -662 -8 -348 -44 -590 -126 -831 -23 -66 -41 -126 -41 -132 0 -10 184 -13 890 -13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782 -59 703 -233 1323 -545 1945 -481 956 -1313 1788 -2270 2268 -620 310 -1239 483 -1940 542 -165 14 -669 10 -840 -5z"/>
                <path d="M2519 3815 c-391 -66 -725 -336 -868 -703 -79 -201 -96 -462 -45 -677 83 -344 338 -641 666 -774 116 -47 205 -69 330 -80 412 -39 811 153 1040 500 193 292 240 648 128 981 -135 403 -492 699 -914 757 -100 14 -241 12 -337 -4z"/>
            </g>
        </svg>
    </a>


    <a target="_blank" class="social" title="Email" href="mailto:Joachim%20Wiberg%20%3ctroglobit&#43;spam@gmail.com%3e">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>




        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 Joachim Wiberg. All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="https://troglobit.com/2016/07/05/multicast-routing-with-pim-sm-over-gre/">Multicast routing with PIM-SM over GRE</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2018-01-23T20:39:36Z" class="post-date">
        January 23, 2018
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>8 mins read</span>
      </span>
    </div>

    
  </div>

  
  

  
</div>

  <p>GRE tunnels are useful in many ways.  This blog post shows how to set up
multicast routing with <a href="https://github.com/troglobit/pimd/" target="_blank">pimd</a> over a
GRE tunnel.  To achieve this we will also set up OSPF over GRE with
<a href="http://www.quagga.net" target="_blank">Quagga</a>, because PIM, unlike DVMRP (<code>mrouted</code>),
require unicast routing rules to be established.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>       .----{ Intranet }----.
</span></span><span style="display:flex;"><span>      /    192.168.1.0/24    \
</span></span><span style="display:flex;"><span>     /                        \
</span></span><span style="display:flex;"><span>.10 /                          \.20
</span></span><span style="display:flex;"><span>.--&#39;---. .1  GRE Tunnel  .2 .---`--.
</span></span><span style="display:flex;"><span>|      |====================|      |
</span></span><span style="display:flex;"><span>|  R1  |   172.16.16.0/30   |  R2  |
</span></span><span style="display:flex;"><span>|      |                    |      |
</span></span><span style="display:flex;"><span>&#39;--.---&#39;                    &#39;------&#39;
</span></span><span style="display:flex;"><span>   | .1                        | .1 
</span></span><span style="display:flex;"><span>   |    10.0.1.0/24            |    10.0.2.0/24
</span></span><span style="display:flex;"><span>   | .2                        | .2 
</span></span><span style="display:flex;"><span>.--&#39;---.                    .--&#39;---.
</span></span><span style="display:flex;"><span>|      |                    |      |
</span></span><span style="display:flex;"><span>|  C1  |                    |  C2  |
</span></span><span style="display:flex;"><span>|      |                    |      |
</span></span><span style="display:flex;"><span>&#39;------&#39;                    &#39;------&#39;
</span></span></code></pre></div><p>In this post we are using the home WiFi network, 192.168.1.0/24, to hook
up the GRE tunnel.  It is just as easy to extend this to a big corporate
Intranet with more routers between <code>R1</code> and <code>R2</code>.  As long as that IT
department takes care of the unicast routing between <code>R1</code> and <code>R2</code> so
that the GRE tunnel can be established.</p>
<p>Now, on router R1 we set up the first GRE tunnel endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ip tunnel add gre0 mode gre remote 192.168.1.20 <span style="color:#fabd2f">local</span> 192.168.1.10 ttl <span style="color:#d3869b">64</span>
</span></span><span style="display:flex;"><span>ip link <span style="color:#fabd2f">set</span> gre0 multicast on
</span></span><span style="display:flex;"><span>ip link <span style="color:#fabd2f">set</span> gre0 up
</span></span><span style="display:flex;"><span>ip addr add 172.16.16.1/30 dev gre0
</span></span></code></pre></div><p>We do not add any static route for <code>R1</code> to reach the LAN on <code>R2</code> that
<code>C2</code> is connected to, that is for OSPF to add dynamically for us later.
Notice, hower, that we must explicitly enable the multicast flag on the
GRE interface, it is not enabled by default in Linux.</p>
<p>On router <code>R2</code> we can now set up the other side of the GRE tunnel:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ip tunnel add gre0 mode gre remote 192.168.1.10 <span style="color:#fabd2f">local</span> 192.168.1.20 ttl <span style="color:#d3869b">64</span>
</span></span><span style="display:flex;"><span>ip link <span style="color:#fabd2f">set</span> gre0 multicast on
</span></span><span style="display:flex;"><span>ip link <span style="color:#fabd2f">set</span> gre0 up
</span></span><span style="display:flex;"><span>ip addr add 172.16.16.2/30 dev gre0
</span></span></code></pre></div><p>Setup of OSPF in Debian or Ubuntu distributions is only an <code>apt-get</code>
away followed by enabling the zebra and ospf daemons:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt-get install quagga
</span></span><span style="display:flex;"><span>sudo editor /etc/quagga/daemons
</span></span></code></pre></div><p>The idea is to set up an OSPF backbone, area 0, for our routers without
wrecking havoc in the big corporate intranet, which may already run OSPF
&hellip; so OSPF should only talk on the <code>gre0</code> interface, and maybe even the
LAN interfaces towards <code>C1</code> and <code>C2</code> (in case we want to expand on this
example later).  In our setup the routers use <code>wlan0</code> to connect to the
intranet.  We can use the sample configuration files to start from:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo cp /usr/share/doc/quagga/examples/zebra.conf.sample /etc/quagga/zebra.conf
</span></span><span style="display:flex;"><span>sudo cp /usr/share/doc/quagga/examples/ospfd.conf.sample /etc/quagga/ospfd.conf
</span></span></code></pre></div><p>The <code>zebra.conf</code> can be left as-is, just edit the <code>ospfd.conf</code> to look
like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>hostname ospfd
</span></span><span style="display:flex;"><span>password zebra
</span></span><span style="display:flex;"><span>router ospf
</span></span><span style="display:flex;"><span>    passive-interface wlan0
</span></span><span style="display:flex;"><span>    redistribute connected
</span></span><span style="display:flex;"><span>    network 172.16.16.0/30 area 0
</span></span></code></pre></div><p>When the routers have peered, the two clients <code>C1</code> and <code>C2</code> should be
able to (unicast) ping each other.  Telnet into the OSPF daemon using
<code>telnet localhost ospfd</code> and type <code>show ip ospf neigh</code> to see all OSPF
neighbors and their status, should be <code>Full/...</code> when done exchanging
routes.  Use <code>show ip ospf route</code> to see the exchanged routes, also
inspect the kernel routing table with <code>route -n</code>.  Use <code>traceroute</code> to
confirm the traffic between clients do traverse the GRE tunnel and not
over the Intranet.</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@C1:~$ traceroute 10.0.2.2
</span></span><span style="display:flex;"><span>traceroute to 10.0.2.2 <span style="color:#fe8019">(</span>10.0.2.2<span style="color:#fe8019">)</span>, <span style="color:#d3869b">30</span> hops max, <span style="color:#d3869b">60</span> byte packets
</span></span><span style="display:flex;"><span> <span style="color:#d3869b">1</span>  10.0.1.1 <span style="color:#fe8019">(</span>10.0.1.1<span style="color:#fe8019">)</span>  0.427 ms  0.384 ms  0.309 ms
</span></span><span style="display:flex;"><span> <span style="color:#d3869b">2</span>  172.16.16.2 <span style="color:#fe8019">(</span>172.16.16.2<span style="color:#fe8019">)</span>  3.135 ms  4.724 ms  5.786 ms
</span></span><span style="display:flex;"><span> <span style="color:#d3869b">3</span>  10.0.2.2 <span style="color:#fe8019">(</span>10.0.2.2<span style="color:#fe8019">)</span>  9.979 ms  10.777 ms  10.676 ms
</span></span></code></pre></div><p>Time for <code>pimd</code> to be started.  Just like OSPF we want <code>pimd</code> to avoid
talking on <code>wlan0</code>, so add the following to the default <code>pimd.conf</code>,
which can otherwise be left as-is:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>phyint wlan0 disable
</span></span></code></pre></div><p>In our case the routers have many interfaces, so we disable <em>all</em>
interfaces using the <code>-N</code> switch to <code>pimd</code> and instead only enable the
interfaces we are intrested in, the GRE tunnel and the client LAN
interface, <code>eth0</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>phyint eth0 enable
</span></span><span style="display:flex;"><span>phyint gre0 enable
</span></span></code></pre></div><p>Make sure to add the <code>phyint</code> setting to the correct place in the file.
Now start pimd on each router, use the debug mode and run in foreground
first to see what happens:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@R1:~$ pimd -N -f -d
</span></span><span style="display:flex;"><span>debug level 0xffffffff <span style="color:#fe8019">(</span>dvmrp_detail,dvmrp_prunes,dvmrp_routes,dvmrp_neighbors,dvmrp_timers,igmp_proto,igmp_timers,igmp_members,trace,timeout,packets,interfaces,kernel,cache,rsrr,pim_detail,pim_hello,pim_register,pim_join_prune,pim_bootstrap,pim_asserts,pim_cand_rp,pim_routes,pim_timers,pim_rpf<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span>02:01:49.616 pimd version 2.3.2 starting ...
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte send buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte recv buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte send buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte recv buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Getting vifs from kernel
</span></span><span style="display:flex;"><span>02:01:49.618 /etc/pimd.conf:0 - Skipping interface lo, either loopback or does not support multicast.
</span></span></code></pre></div><p>&hellip; and on <code>R2</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@R2:~$ pimd -N -f -d
</span></span><span style="display:flex;"><span>debug level 0xffffffff <span style="color:#fe8019">(</span>dvmrp_detail,dvmrp_prunes,dvmrp_routes,dvmrp_neighbors,dvmrp_timers,igmp_proto,igmp_timers,igmp_members,trace,timeout,packets,interfaces,kernel,cache,rsrr,pim_detail,pim_hello,pim_register,pim_join_prune,pim_bootstrap,pim_asserts,pim_cand_rp,pim_routes,pim_timers,pim_rpf<span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span>02:01:49.616 pimd version 2.3.2 starting ...
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte send buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte recv buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte send buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Got <span style="color:#d3869b">262144</span> byte recv buffer size in <span style="color:#d3869b">0</span> iterations
</span></span><span style="display:flex;"><span>02:01:49.617 Getting vifs from kernel
</span></span><span style="display:flex;"><span>02:01:49.618 /etc/pimd.conf:0 - Skipping interface lo, either loopback or does not support multicast.
</span></span></code></pre></div><p>To verify multicast routing works we start a multicast sender on <code>C1</code>
and a receiver (sink) on <code>C2</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@C1:~$ mcjoin -s -t <span style="color:#d3869b">10</span>
</span></span><span style="display:flex;"><span>root@C2:~$ mcjoin
</span></span><span style="display:flex;"><span>.................o
</span></span></code></pre></div><p>Notice the TTL adjustment (<code>-t 10</code>) on the sender side, this is needed
because the default TTL for multicast, due to safety concerns, is 1.</p>
<p>The log on the routers should look something like this (snippet):</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>01:44:16.750 accept_group_report(): igmp_src 10.0.2.2 ssm_src 0.0.0.0 group 225.1.2.3 report_type 34
</span></span><span style="display:flex;"><span>01:44:16.750 Set delete timer for group: 225.1.2.3
</span></span><span style="display:flex;"><span>01:44:16.750 Adding vif 4 for group 225.1.2.3
</span></span><span style="display:flex;"><span>01:44:16.877 Received IGMP v3 Membership Report from 172.16.16.1 to 224.0.0.22
</span></span><span style="display:flex;"><span>01:44:16.877 accept_membership_report(): IGMP v3 report, 40 bytes, from 172.16.16.1 to 224.0.0.22 with 4 group records.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Virtual Interface Table ======================================================
</span></span><span style="display:flex;"><span>Vif  Local Address    Subnet              Thresh  Flags      Neighbors
</span></span><span style="display:flex;"><span>---  ---------------  ------------------  ------  ---------  -----------------
</span></span><span style="display:flex;"><span>  0  192.168.1.123    192.168.1                1  DISABLED
</span></span><span style="display:flex;"><span>  1  172.17.0.1       172.17                   1  DISABLED
</span></span><span style="display:flex;"><span>  2  192.168.122.1    192.168.122              1  DISABLED
</span></span><span style="display:flex;"><span>  3  172.16.16.2      172.16.16/30             1  DR PIM     172.16.16.1
</span></span><span style="display:flex;"><span>  4  10.0.2.1         10.0.2                   1  DR NO-NBR
</span></span><span style="display:flex;"><span>  5  172.16.16.2      register_vif0            1 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Vif  SSM Group        Sources             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Multicast Routing Table ======================================================
</span></span><span style="display:flex;"><span>----------------------------------- (*,G) ------------------------------------
</span></span><span style="display:flex;"><span>Source           Group            RP Address       Flags
</span></span><span style="display:flex;"><span>---------------  ---------------  ---------------  ---------------------------
</span></span><span style="display:flex;"><span>INADDR_ANY       225.1.2.3        10.0.2.1         WC RP
</span></span><span style="display:flex;"><span>Joined   oifs: ......              
</span></span><span style="display:flex;"><span>Pruned   oifs: ......              
</span></span><span style="display:flex;"><span>Leaves   oifs: ....l.              
</span></span><span style="display:flex;"><span>Asserted oifs: ......              
</span></span><span style="display:flex;"><span>Outgoing oifs: ....o.              
</span></span><span style="display:flex;"><span>Incoming     : .....I              
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3  4  5
</span></span><span style="display:flex;"><span>             0    45     0       0        0  0  0  0  0  0
</span></span><span style="display:flex;"><span>----------------------------------- (S,G) ------------------------------------
</span></span><span style="display:flex;"><span>Source           Group            RP Address       Flags
</span></span><span style="display:flex;"><span>---------------  ---------------  ---------------  ---------------------------
</span></span><span style="display:flex;"><span>192.168.64.2     225.1.2.3        10.0.2.1         SPT CACHE SG
</span></span><span style="display:flex;"><span>Joined   oifs: ......              
</span></span><span style="display:flex;"><span>Pruned   oifs: ......              
</span></span><span style="display:flex;"><span>Leaves   oifs: ....l.              
</span></span><span style="display:flex;"><span>Asserted oifs: ......              
</span></span><span style="display:flex;"><span>Outgoing oifs: ....o.              
</span></span><span style="display:flex;"><span>Incoming     : ...I..              
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3  4  5
</span></span><span style="display:flex;"><span>           200    55     0       0        0  0  0  0  0  0
</span></span><span style="display:flex;"><span>--------------------------------- (*,*,G) ------------------------------------
</span></span><span style="display:flex;"><span>Number of Groups: 1
</span></span><span style="display:flex;"><span>Number of Cache MIRRORs: 1
</span></span><span style="display:flex;"><span>------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Candidate Rendezvous-Point Set ===============================================
</span></span><span style="display:flex;"><span>RP address       Incoming  Group Prefix        Priority  Holdtime
</span></span><span style="display:flex;"><span>---------------  --------  ------------------  --------  ---------------------
</span></span><span style="display:flex;"><span>10.0.2.1         5         224/4               20        70      
</span></span><span style="display:flex;"><span>10.0.1.1         3         224/4               20        55      
</span></span><span style="display:flex;"><span>169.254.0.1      1         232/8               1         65535   
</span></span><span style="display:flex;"><span>------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Current BSR address: 10.0.2.1
</span></span></code></pre></div><p>In normal operation, i.e. without the debug flag <code>-d</code>, the routing table
and other useful PIM information can be queried from the running <code>pimd</code>
by calling it in client mode.  The following is a wrapper for sending a
<code>SIGUSR1</code> signal to the daemon and reading <code>/var/run/pimd/pimd.dump</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>root@R2:~$ pimd -r
</span></span><span style="display:flex;"><span>Virtual Interface Table ======================================================
</span></span><span style="display:flex;"><span>Vif  Local Address    Subnet              Thresh  Flags      Neighbors
</span></span><span style="display:flex;"><span>---  ---------------  ------------------  ------  ---------  -----------------
</span></span><span style="display:flex;"><span>  0  192.168.1.123    192.168.1                1  DISABLED
</span></span><span style="display:flex;"><span>  1  172.17.0.1       172.17                   1  DISABLED
</span></span><span style="display:flex;"><span>  2  192.168.122.1    192.168.122              1  DISABLED
</span></span><span style="display:flex;"><span>  3  172.16.16.2      172.16.16/30             1  DR PIM     172.16.16.1    
</span></span><span style="display:flex;"><span>  4  10.0.2.1         10.0.2                   1  DR NO-NBR
</span></span><span style="display:flex;"><span>  5  172.16.16.2      register_vif0            1 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Vif  SSM Group        Sources             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Multicast Routing Table ======================================================
</span></span><span style="display:flex;"><span>----------------------------------- (*,G) ------------------------------------
</span></span><span style="display:flex;"><span>Source           Group            RP Address       Flags
</span></span><span style="display:flex;"><span>---------------  ---------------  ---------------  ---------------------------
</span></span><span style="display:flex;"><span>INADDR_ANY       225.1.2.3        10.0.2.1         WC RP
</span></span><span style="display:flex;"><span>Joined   oifs: ......              
</span></span><span style="display:flex;"><span>Pruned   oifs: ......              
</span></span><span style="display:flex;"><span>Leaves   oifs: ....l.              
</span></span><span style="display:flex;"><span>Asserted oifs: ......              
</span></span><span style="display:flex;"><span>Outgoing oifs: ....o.              
</span></span><span style="display:flex;"><span>Incoming     : .....I              
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3  4  5
</span></span><span style="display:flex;"><span>             0    20     0       0        0  0  0  0  0  0
</span></span><span style="display:flex;"><span>----------------------------------- (S,G) ------------------------------------
</span></span><span style="display:flex;"><span>Source           Group            RP Address       Flags
</span></span><span style="display:flex;"><span>---------------  ---------------  ---------------  ---------------------------
</span></span><span style="display:flex;"><span>10.0.1.2         225.1.2.3        10.0.2.1         SPT CACHE SG
</span></span><span style="display:flex;"><span>Joined   oifs: ......              
</span></span><span style="display:flex;"><span>Pruned   oifs: ......              
</span></span><span style="display:flex;"><span>Leaves   oifs: ....l.              
</span></span><span style="display:flex;"><span>Asserted oifs: ......              
</span></span><span style="display:flex;"><span>Outgoing oifs: ....o.              
</span></span><span style="display:flex;"><span>Incoming     : ...I..              
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3  4  5
</span></span><span style="display:flex;"><span>           185    10     0       0        0  0  0  0  0  0
</span></span><span style="display:flex;"><span>--------------------------------- (*,*,G) ------------------------------------
</span></span><span style="display:flex;"><span>Number of Groups: 1
</span></span><span style="display:flex;"><span>Number of Cache MIRRORs: 1
</span></span><span style="display:flex;"><span>------------------------------------------------------------------------------
</span></span></code></pre></div><p>You can also verify that <code>pimd</code> actually sets routes in the kernel
multicast routing table with:</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@R2:~$ ip mroute
</span></span><span style="display:flex;"><span><span style="color:#fe8019">(</span>10.0.1.2, 225.1.2.3<span style="color:#fe8019">)</span>        Iif: gre0       Oifs: eth0
</span></span></code></pre></div><h2 id="caveats">Caveats</h2>
<p>There are quite a few caveats to watch out for with multicast routing.
Here are a few:</p>
<ol>
<li>Check the TTL of the multicast stream, must be &gt;1 to be routed.
<strong>Rule of thumb:</strong> increase with each router in topology.</li>
<li>Check the MTU of the interfaces in the path.</li>
<li>Check the reverse path, make sure you have unicast connectivity
between end nodes &ndash; PIM requires this to work!</li>
<li>Check the multicast sender&rsquo;s source IP, verify that it&rsquo;s not a
unroutable link-local (169.254) address.</li>
<li>Have the PIM routers peered?  Should list &lsquo;PIM&rsquo; and a neighbor IP
in the output of <code>pimd -r</code>.  If NO-NBR or DISABLED is shown you
have a network or <code>pimd.conf</code> problem.</li>
<li>As of this writing <code>pimd</code> is a bit sensitive to topology changes.
See <a href="https://github.com/troglobit/pimd/issues/79" target="_blank">issue #79</a> for
details and possible future resolution.</li>
</ol>
<p>For other questions, ideas on setting up multicast routing, see the
general <a href="/multicast-howto.html">Multicast HowTo</a>, or file a bug report
at <a href="https://github.com/troglobit" target="_blank">GitHub</a></p>
<p>That&rsquo;s it, good luck!</p>
  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://troglobit.com/2017/09/19/threads-vs-event-loop--again/?ref=footer"><span style="font-weight:bold;">« Previous</span><br>Threads vs Event Loop, Again ...</a>
        
	    
            <div class="next-post">
                <a href="https://troglobit.com/post/2018-02-15-slow-down/?ref=footer"><span style="font-weight:bold;">Next »</span><br>Slow Down</a>
            </div>
        
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#caveats">Caveats</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
